# X6画布功能说明文档

## 概述

基于AntV X6的可视化工作流编辑器，支持拖拽式节点创建、连线、属性配置，最终生成Lua代码。该编辑器具备完整的节点管理、分组管理、迭代器管理、决策表编辑等高级功能。

## 核心组件

- **WorkflowDesigner.vue**: 工作流设计器核心组件
- **CustomNodeManager.ts**: 自定义节点配置生成器
- **NodeFactory.ts**: 节点工厂，支持多种节点类型创建
- **WorkflowValidator.ts**: 工作流验证器
- **GroupNode.ts**: 分组节点实现
- **DndPanel.vue**: 拖拽面板组件，用于从左侧拖拽创建节点

## 工具栏功能

### 拖拽面板 (DndPanel)
**位置**: `src/components/panels/DndPanel.vue`

**功能特性**:
- **位置**: 位于画布左侧，垂直布局
- **拖拽功能**: 支持鼠标和触摸事件拖拽创建节点
- **节点列表**: 显示所有可用的基础函数节点
- **触摸优化**: 支持移动端和平板端的触摸拖拽，防止触发页面返回手势
- **悬停提示**: 鼠标悬停500ms后显示节点详细信息

**布局特点**:
- 固定宽度100px，高度自适应
- 节点卡片尺寸80x80px
- 垂直排列，间距10px
- 支持滚动显示更多节点

**事件处理**:
- `@node-mouse-down`: 触发节点拖拽事件
- `@touchstart`: 触摸开始事件，用于移动端拖拽
- `@touchmove`: 触摸移动事件，阻止默认行为避免页面滚动
- `@mouseenter`: 鼠标进入事件，延迟显示节点提示
- `@mouseleave`: 鼠标离开事件，隐藏节点提示

### 主要工具栏
**位置**: `src/components/workflow/WorkflowDesigner.vue` - 模板部分

**功能按钮**:
- **一键布局**: 自动排列所有节点位置
- **清空**: 清空当前画布
- **保存**: 保存当前工作流（需要规则ID）
- **另存**: 另存为新的工作流
- **撤销**: 撤销上一步操作
- **重做**: 重做上一步操作
- **导入**: 导入工作流数据
- **导出**: 导出工作流数据

### 工作流操作工具栏
- **测试**: 测试生成的Lua代码（需要规则ID）

### 节点操作功能
- **复制**: 支持多节点复制，自动处理迭代器节点关系
- **删除**: 删除选中节点（迭代器开始节点不允许删除）
- **折叠/展开**: 支持迭代器和分组节点的折叠展开
- **重命名**: 支持分组节点重命名

## 画布功能限制设置

### 连接限制配置
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `initGraph()` 方法

```typescript
connecting: {
  snap: true,                    // 启用吸附
  allowBlank: false,            // 禁止空白连接
  allowLoop: false,             // 禁止自循环
  highlight: true,              // 启用高亮
  router: {
    name: 'manhattan',          // 使用曼哈顿路由
    args: { padding: 30 }
  },
  connector: {
    name: 'rounded',            // 圆角连接器
    args: { radius: 30 }
  },
  connectionPoint: 'boundary',  // 连接点类型
  allowMulti: true,             // 允许多连接
  validateConnection(args) {    // 连接验证函数
    // 验证逻辑
  }
}
```

### 交互限制配置
```typescript
interacting: {
  nodeMovable: true,        // 节点可移动
  edgeMovable: true,        // 边可移动
  vertexMovable: true,      // 顶点可移动
  vertexAddable: true,      // 可添加顶点
  vertexDeletable: true,    // 可删除顶点
  arrowheadMovable: true    // 箭头可移动
}
```

### 缩放限制
```typescript
scaling: { 
  min: 0.2,    // 最小缩放比例
  max: 3       // 最大缩放比例
}
```

### 嵌入限制配置
```typescript
embedding: {
  enabled: true,            // 启用节点嵌入
  findParent({ node }) {    // 父节点查找逻辑
    // 迭代器节点不允许嵌套到其他迭代器中
    // 只有分组节点和迭代器节点可以作为父节点
  }
}
```

### 端口连接验证
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `validateConnection` 函数

**验证规则**:
- 禁止输入端口连接到输入端口
- 禁止输出端口连接到输出端口
- 组合节点不允许连接
- 迭代器的子节点不允许连接到外面
- 端口ID必须存在且有效

## 节点设计

### 节点类型分类

#### 函数节点 (func)
- 执行具体的业务逻辑
- 支持动态端口数量（根据inputData的sourceType为'node'的数量）
- 从函数库中获取，支持分页加载

#### 逻辑节点 (logic)
- **条件判断节点** (ifelse): 左侧1个输入端口，右侧多个输出端口
- **迭代器节点** (iterator): 支持循环处理数据集合

#### 特殊节点类型
- **迭代器节点** (IteratorNode): 可折叠的容器节点，支持子节点管理
- **分组节点** (GroupNode): 逻辑分组容器，支持折叠/展开
- **信息面板节点** (InfoPanelNode): 显示节点详细信息

### 节点外观设计
**位置**: `src/utils/workflow/CustomNodeManager.ts`

**设计特点**:
- 固定宽度300px，高度根据内容动态计算
- 标题栏高度36px，背景色#f5f7fa
- 支持备注文本显示，自动换行
- 圆角设计，阴影效果
- 端口采用圆形设计，蓝色边框

**高度计算逻辑**:
- 计算备注文本高度（每行24px）
- 计算端口需求高度（支持动态端口数量）
- 取两者最大值作为最终高度

### 端口布局算法
**位置**: `src/utils/workflow/CustomNodeManager.ts` - `getPortPosition()` 函数

**布局规则**:
- 输入端口在左侧，输出端口在右侧
- 单个端口居中显示
- 多个端口均匀分布
- 端口间距24px
- 支持端口标题和类型信息显示

### 桩点生成逻辑
**位置**: `src/utils/workflow/CustomNodeManager.ts` - `generatePorts()` 函数

**生成策略**:
- **条件节点** (ifelse): 左侧1个输入端口，右侧根据outputData数量动态生成
  - 第一个端口标记为'if'，最后一个标记为'else'，中间标记为'elseif'
- **函数节点**: 根据inputData中sourceType为'node'的参数数量动态生成
  - 必须至少生成1个入参桩点（默认'in_1'）
  - 端口ID使用原始数据的portId，保持数据一致性
  - 支持参数分组和描述信息显示
- **输出端口**: 默认生成1个输出端口（'out_1'）
  - 支持动态端口数量扩展
  - 端口标题和描述从outputData中获取

**端口配置生成**:
```typescript
function createPortConfig(id: string, group: 'in' | 'out', position: any, portTitle = '', desc = '', typeText = '') {
  // 端口标题处理：超过13字符时截断并添加类型信息
  let portTitleType = portTitle
  if(portTitleType.length > 13) {
    portTitleType = portTitleType.substring(0,13) + '...\n' + typeText
  } else {
    portTitleType = portTitleType + '\n'+ typeText
  }
  
  return {
    id, group, args: position, zIndex: 10,
    attrs: {
      circle: { r: 5, magnet: true, stroke: '#1890ff', strokeWidth: 2.5, fill: '#fff' },
      text: { text: portTitleType, fontSize: 13, textWrap: { width: 95, height: 80, overflow: 'hidden', ellipsis: true } },
      portTitle: portTitle, desc: desc
    },
    uniqueId: 'port_' + Date.now() + Math.random().toString(36).substring(2, 15)
  }
}
```

## 高级功能特性

### 分组管理
**位置**: `src/utils/workflow/GroupManager.ts`

**功能特性**:
- 支持多节点组合创建分组
- 分组节点可折叠/展开
- 支持分组重命名
- 支持取消分组
- 分组边界自动计算

**分组节点特点**:
- 支持折叠/展开状态
- 可调整大小
- 支持子节点管理
- 分组标题可编辑

### 边连接管理
**位置**: `src/utils/workflow/EdgeCorrectionManager.ts`

**功能特性**:
- 连接线样式自动调整（基于节点距离）
- 类型兼容性验证
- 连接线颜色管理
- 虚拟边支持
- 连接线工具集成

**连接线样式规则**:
- 距离小于400px且垂直重叠时使用直线
- 其他情况使用曼哈顿路由+圆角连接器
- 支持动态样式切换

**连接线样式自动调整逻辑**:
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `updateEdgeConnectorBasedOnDistance()` 函数

```typescript
function updateEdgeConnectorBasedOnDistance(edge: any) {
  const sourceCell = edge.getSourceCell()
  const targetCell = edge.getTargetCell()

  if (sourceCell && targetCell) {
    // 获取节点边界框信息
    const sourceBBox = sourceCell.getBBox()
    const targetBBox = targetCell.getBBox()
    
    // 计算节点中心点距离
    const sourceCenterX = sourceBBox.center.x
    const sourceCenterY = sourceBBox.center.y
    const targetCenterX = targetBBox.center.x
    const targetCenterY = targetBBox.center.y

    const distance = Math.sqrt(
      Math.pow(targetCenterX - sourceCenterX, 2) +
      Math.pow(targetCenterY - sourceCenterY, 2)
    )
    
    // 获取节点高度信息
    const sourceHeight = sourceCell.size().height
    const targetHeight = targetCell.size().height
    
    // 样式选择逻辑
    if ((targetCenterX - sourceCenterX) < 400) {
      // 水平距离小于400px的情况
      if (Math.abs(targetCenterY - sourceCenterY) < (targetHeight / 2 + sourceHeight / 2)) {
        // 垂直重叠时使用直线连接
        edge.setRouter('normal')
        edge.setConnector('normal')
      } else {
        // 垂直不重叠时使用曼哈顿路由
        edge.setRouter('manhattan')
        edge.setConnector('rounded', { radius: 30 })
      }
    } else {
      // 水平距离大于400px时使用曼哈顿路由
      edge.setRouter('manhattan')
      edge.setConnector('rounded', { radius: 30 })
    }
  }
}
```

**样式选择策略**:
1. **直线连接**: 当节点水平距离<400px且垂直重叠时
2. **曼哈顿路由**: 当节点水平距离≥400px或垂直不重叠时
3. **圆角连接器**: 配合曼哈顿路由使用，半径30px

### 边的校验逻辑
**位置**: `src/utils/workflow/EdgeCorrectionManager.ts` - `validateEdgeTypeAndSetColor()` 方法

**校验流程**:
1. **端口类型获取**: 从源节点和目标节点获取端口类型信息
2. **类型兼容性验证**: 调用`validateTypeCompatibility()`进行类型匹配
3. **样式设置**: 根据验证结果设置不同的边样式

**边样式分类**:
```typescript
private readonly EDGE_STYLES = {
  error: { stroke: '#ff4d4f', strokeWidth: 2 },  // 错误红色
  normal: { stroke: '#1890ff', strokeWidth: 2 }, // 默认蓝色
  pass: { stroke: '#1890ff', strokeWidth: 2 },   // 通过蓝色
  alert: { stroke: '#e2e2e2', strokeWidth: 2 },  // 警告灰色
}
```

**类型兼容性规则**:
- 支持`any`类型的兼容（显示为警告色）
- 支持`table`类型的subType验证
- 支持基本类型的精确匹配
- 类型不匹配时显示错误色

**边预览颜色逻辑**:
```typescript
edgePreviewColor(args: any) {
  // 1. 检查是否有目标节点
  if (!targetNodeId) return defaultColor
  
  // 2. 获取源和目标端口类型
  const sourceType = this.getNodePortType(sourceNodeId, sourcePortId, true)
  const targetType = this.getNodePortType(targetNodeId, targetPortId, false)
  
  // 3. 验证类型兼容性
  const isValid = this.validateTypeCompatibility(sourceType, targetType)
  
  // 4. 设置颜色：错误/警告/正常
  if (!isValid) {
    tempColor = this.EDGE_STYLES.error
  } else if (hasAnyType) {
    tempColor = this.EDGE_STYLES.alert
  } else {
    tempColor = this.EDGE_STYLES.normal
  }
}
```

## 业务限制

### 工作流验证模态框
**位置**: `src/components/workflow/panels/WorkflowValidationModal.vue`

**功能特性**:
- 显示工作流验证错误和警告
- 支持错误节点快速定位
- 错误分类显示（工作流错误、边连接错误）
- 支持节点选择跳转

### 工作流验证规则
**位置**: `src/utils/workflow/WorkflowValidator.ts`

#### 节点入参数量验证
- 规则：连接到当前节点的边的数量 + 当前数据源类型是input的数量 = 节点入参数量
- 实际数量小于预期数量时为错误
- 实际数量大于预期数量时为警告

#### 参数类型匹配验证
- 根据实际的每个入参对应的节点的返回值和当前入参的参数类型做匹配
- 类型不匹配时报告错误
- 支持table类型的subType验证

#### 条件函数验证
- 条件函数的每个出参都必须连接到其他节点
- logicData.source不能为空
- outputData每项的functionCode不能为空（最后一个分支除外）

#### 迭代器节点验证
- 迭代器起始节点必须连接到其他节点
- 迭代器子节点不允许连接到外部节点
- 迭代器入参必须设置数据源

#### 外部决策表验证
- 外部决策表节点必须配置正确的数据源
- 决策表参数配置必须完整

#### 孤立节点验证
- 如果一个节点与其他节点都没有边的关系，则报错

### 数据源选择限制
**位置**: `src/views/rule/RuleEdit.vue` - `getAvailableSourceOptions()` 函数

**选择规则**:
- 如果source或target任意一个是logic节点，应允许选择
- 对于table类型，需要校验subType
- 其他类型直接比较mainType
- 支持any类型的兼容

### 保存限制
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `handleSave()` 方法

**保存前验证**:
- 必须通过工作流验证
- 函数配置数据必须已加载
- 规则ID不能为空

## 核心数据结构

### 工作流数据 (WorkflowData)
```typescript
interface WorkflowData {
  id: string              // 工作流ID
  ruleName: string        // 规则名称
  nodeList: WorkflowNode[] // 节点列表
  edges: WorkflowEdge[]    // 边列表
  groupList: GroupNodeData[] // 分组列表
  lua: string             // Lua脚本
}
```

### 工作流节点 (WorkflowNode)
```typescript
interface WorkflowNode {
  id: string                    // 节点ID
  funcId: string               // 函数ID
  funcType: 'func' | 'logic'   // 节点类型
  title: string                // 节点标题
  remark?: string              // 节点备注
  pos?: Position               // 节点位置
  width?: number               // 节点宽度
  height?: number              // 节点高度
  inputData?: InputData[]      // 输入参数
  outputData?: OutputData[]    // 输出参数
  logicData?: LogicData        // 逻辑节点数据
  children?: string[]          // 子节点ID列表（迭代器/分组）
  isCollapsed?: boolean        // 是否折叠
}
```

### 输入参数 (InputData)
```typescript
interface InputData {
  paramName: string           // 参数名称
  type: string               // 参数类型
  subType?: string           // 参数子类型
  defaultValue?: any         // 默认值
  source: string             // 来源节点ID或输入框字符串
  sourceType?: 'input' | 'node' // 来源类型
  portId?: string            // 唯一端口ID
  widgetType?: string        // 控件类型
  options?: any[]            // 选项列表
  rules?: any                // 验证规则
  attributes?: any           // 属性配置
}
```

### 输出参数 (OutputData)
```typescript
interface OutputData {
  paramName: string          // 参数名称
  type: string              // 参数类型
  subType?: string          // 参数子类型
  functionCode?: string   // 条件检查（条件节点专用）
  portId?: string           // 唯一端口ID
  widgetType?: string       // 控件类型
  defaultValue?: any        // 默认值
  options?: any[]           // 选项列表
  rules?: any               // 验证规则
  attributes?: any          // 属性配置
}
```

### 工作流边 (WorkflowEdge)
```typescript
interface WorkflowEdge {
  id: string        // 边ID
  type: string      // 边类型
  source: string    // 源节点ID
  target: string    // 目标节点ID
  sourcePort?: string // 源端口ID
  targetPort?: string // 目标端口ID
}
```

### 分组节点数据 (GroupNodeData)
```typescript
interface GroupNodeData {
  id: string        // 分组ID
  title: string     // 分组标题
  children: string[] // 子节点ID列表
  isCollapsed: boolean // 是否折叠
  pos: Position     // 位置
  width: number     // 宽度
  height: number    // 高度
}
```

## 插件系统

### 已集成插件
**位置**: `src/components/workflow/plugins/X6Plugin.ts` - `registerPlugins()` 方法

- **Snapline**: 对齐线插件
  - 启用吸附，容差10px，清理时间3000ms
  - 支持锐角对齐，支持调整大小
- **History**: 历史记录插件（撤销/重做）
  - 无限制栈大小，记录所有操作
  - 支持忽略特定操作的撤销恢复
- **Clipboard**: 剪贴板插件
- **Selection**: 选择插件
  - 支持多选，显示节点选择框
  - 支持橡皮筋选择
- **Dnd**: 拖拽插件
- **MiniMap**: 小地图插件
- **Keyboard**: 键盘快捷键插件
  - 支持Ctrl+G创建分组
  - 支持Ctrl+Shift+G取消分组
  - 支持Ctrl+C复制节点
  - 支持Ctrl+V粘贴节点
  - 支持Delete删除节点
- **Layout**: 自动布局插件（基于dagre）

### 插件配置
- 对齐线：启用吸附，容差10px，清理时间3000ms
- 历史记录：无限制栈大小，记录所有操作
- 选择插件：支持多选，显示节点选择框
- 自动布局：支持一键布局功能

## 事件系统

### 主要事件监听
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `registerGraphEvents()` 方法

- `history:change`: 历史记录变化
- `history:undo`: 撤销操作
- `history:redo`: 重做操作
- `selection:changed`: 选择变化
- `blank:click`: 空白区域点击
- `node:added`: 节点添加
- `node:change:position`: 节点位置变化
- `node:change:ports`: 节点端口变化
- `node:removed`: 节点删除
- `node:click`: 节点点击
- `node:mouseenter`: 节点鼠标进入
- `node:mouseleave`: 节点鼠标离开
- `node:customer_collapse`: 节点折叠
- `node:copy_mouseenter`: 节点复制
- `node:del_mouseenter`: 节点删除
- `edge:added`: 边添加
- `edge:removed`: 边删除
- `edge:connected`: 边连接完成
- `edge:mouseenter`: 边鼠标进入
- `edge:mouseleave`: 边鼠标离开
- `node:port:mouseenter`: 端口鼠标进入
- `node:port:mouseleave`: 端口鼠标离开
- `node:port:click`: 端口点击

**端口交互功能**:
- **鼠标悬停**: 输出端口显示连接提示和搜索按钮
- **点击事件**: 支持从端口直接触发节点搜索
- **动态显示**: 根据连接状态动态显示/隐藏端口工具

### 事件处理逻辑
- 节点添加时自动同步到workflowData
- 位置变化时更新节点pos属性
- 边连接时自动分配输入端口
- 选择变化时显示属性面板
- 支持撤销/重做操作的数据同步
- 端口变化时自动更新节点数据

### 节点的数据同步逻辑
**位置**: `src/components/workflow/WorkflowDesigner.vue` - `registerGraphEvents()` 方法

**节点生命周期事件处理**:

#### 节点添加同步
```typescript
graph.on('node:added', ({ node }: { node: any }) => {
  if (node.shape === 'customNode') {
    // 检查节点是否已存在，避免重复添加
    if (!workflowData.value.nodeList.find((n: any) => n.id === node.data.id)) {
      // 同步节点位置信息
      node.data.pos = { x: node.getPosition().x, y: node.getPosition().y }
      // 添加到工作流节点列表
      workflowData.value.nodeList.push(node.data)
    }
  }
})
```

#### 节点位置变化同步
```typescript
graph.on('node:change:position', ({ node }: { node: any }) => {
  if (node.shape === 'customNode') {
    const nodeId = node.id
    const position = node.position()
    // 查找并更新节点数据中的位置信息
    const nodeData = workflowData.value.nodeList.find(n => n.id === nodeId)
    if (nodeData) {
      nodeData.pos = { x: position.x, y: position.y }
    }
    
    // 更新相连边的连接线样式
    const connectedEdges = graph.getConnectedEdges(node)
    connectedEdges.forEach((edge: any) => {
      updateEdgeConnectorBasedOnDistance(edge)
    })
  }
})
```

#### 节点删除同步
```typescript
graph.on('node:removed', ({ node }: { node: any }) => {
  if (node.shape === 'customNode') {
    const nodeId = node.id
    // 从工作流节点列表中移除
    const nodeData = workflowData.value.nodeList.find(n => n.id === nodeId)
    if (nodeData) {
      workflowData.value.nodeList.splice(workflowData.value.nodeList.indexOf(nodeData), 1)
    }
    // 清理选中状态
    onNodeSelected(null)
  }
})
```

#### 端口变化同步
```typescript
graph.on('node:change:ports', ({ node }: { node: any }) => {
  if (node.shape === 'customNode') {
    // 处理端口变化时的数据同步
    if (!workflowData.value.nodeList.find((n: any) => n.id === node.data.id)) {
      node.data.pos = { x: node.getPosition().x, y: node.getPosition().y }
      workflowData.value.nodeList.push(node.data)
    }
  }
})
```

**边数据同步逻辑**:

**边工具集成**:
```typescript
graph.on('edge:mouseenter', ({ edge }: { edge: any }) => {
  // 设置边高亮样式
  edge.attr('line/strokeWidth', 3)
  
  // 添加边工具
  edge.addTools([
    // 目标箭头
    {
      name: 'target-arrowhead',
      args: { attrs: { fill: edge.hasCorrectionText ? '#ff6b6b' : '#1890ff' } }
    },
    // 添加连接按钮
    {
      name: 'button',
      args: {
        markup: [
          { tagName: 'circle', selector: 'button', attrs: { r: 10, fill: '#147FFA', cursor: 'pointer' } },
          { tagName: 'text', textContent: '+', selector: 'icon', attrs: { fill: 'white', fontSize: 20, textAnchor: 'middle', y: '6px' } }
        ],
        distance: 0.5,
        onClick({cell, e}: any) {
          // 触发搜索模态框，支持从边添加新连接
          emit('show-search-modal', { 
            x: e.clientX + 10, 
            y: e.clientY, 
            nodeId: sourceNodeId, 
            portId: sourcePortId, 
            fromEdgeAdd: true 
          })
        }
      }
    }
  ])
})
```

**边工具特性**:
- **高亮显示**: 鼠标悬停时边宽增加到3px
- **动态箭头**: 根据边状态显示不同颜色的箭头
- **快速连接**: 支持从边直接添加新连接
- **智能定位**: 工具按钮位置根据边长度自动调整

#### 边添加同步
```typescript
graph.on('edge:added', ({ edge }: { edge: any }) => {
  // 跳过虚拟边
  if (edge.id.startsWith('virtual_')) return
  
  // 创建新的边数据对象
  const newEdge = {
    id: edge.id,
    type: 'data_flow',
    source: edge.getSourceCellId(),
    target: edge.getTargetCellId(),
    sourcePort: edge.getSourcePortId(),
    targetPort: edge.getTargetPortId()
  }
  
  // 添加到工作流边列表
  if (!workflowData.value.edges.find(e => e.id === newEdge.id)) {
    workflowData.value.edges.push(newEdge)
  }
  
  // 清理源节点的plus显示
  const sourceNode = graph.getCellById(edge.getSourceCellId())
  if (sourceNode && sourceNode.shape === 'customNode') {
    sourceNode.clearPortCount()
  }
  
  // 更新连接线样式和验证
  updateEdgeConnectorBasedOnDistance(edge)
  validateEdgeTypeAndSetColor(edge)
})
```

#### 边连接完成同步
```typescript
graph.on('edge:connected', ({ edge }: { edge: any }) => {
  // 获取连接信息
  const newSource = edge.getSourceCellId()
  const newSourcePort = edge.getSourcePortId()
  const newTarget = edge.getTargetCellId()
  const newTargetPort = edge.getTargetPortId()
  
  // 清理旧目标节点的数据源
  if (oldTargetNode && oldTargetNode.inputData) {
    oldTargetNode.inputData.forEach((inp: any) => {
      if(inp.source === newSource || upstreamNodeIds.includes(inp.source)) {
        inp.source = ''
      }
    })
  }
  
  // 自动分配新目标节点的输入参数
  if (newTargetNode && newTargetNode.inputData) {
    const targetParams = newTargetNode.inputData.filter((inp: any) => inp.sourceType === 'node')
    for (let i = 0; i < targetParams.length; i++) {
      const inp = targetParams[i]
      if (inp.source === '' || inp.source === undefined) {
        inp.source = upstreamNodeIds.length > 0 ? upstreamNodeIds[0] : newSource
        break
      }
    }
  }
  
  // 更新边数据
  if (wfEdge) {
    wfEdge.source = newSource
    wfEdge.target = newTarget
    wfEdge.sourcePort = newSourcePort
    wfEdge.targetPort = newTargetPort
  }
})
```

**数据同步的关键特性**:
- **实时同步**: 所有节点和边的变化都会实时反映到workflowData中
- **位置同步**: 节点移动时自动更新pos属性
- **关系同步**: 边连接时自动更新节点的source属性
- **状态清理**: 边删除时自动清理相关的数据源引用
- **样式更新**: 位置变化时自动更新连接线样式
- **验证触发**: 边操作后自动触发类型验证和样式设置

#### 撤销/重做数据同步
```typescript
graph.on('history:undo', ({ cmds }: { cmds: any[] }) => {
  cmds.forEach(cmd => {
    // 节点名称变更同步
    if (cmd.options?.propertyPath === 'attrs/title/html') {
      const node = workflowData.value.nodeList.find(n => n.id === cmd.data.id)
      const oldTitle = cmd.data?.prev?.attrs?.title?.text
      if (node && oldTitle) {
        node.title = oldTitle
      }
    }
    // 端口变化同步
    else if (cmd.event === 'cell:change:ports') {
      const portList = cmd.data?.prev?.ports?.items
      if (portList) {
        handlePortChange(cmd.data.id, portList)
      }
    }
    // 可见性变化同步
    else if (cmd.event === 'cell:change:visible') {
      if (!cmd.data?.prev?.visible && cmd.data?.next?.visible == false) {
        const cell = graph.getCellById(cmd.data.id)
        if (cell) {
          cell.hide({ ignoreHistory: true })
          cell.show({ ignoreHistory: true })
        }
      }
    }
  })
})

graph.on('history:redo', ({ cmds }: { cmds: any[] }) => {
  cmds.forEach(cmd => {
    // 节点名称变更同步
    if (cmd.options?.propertyPath === 'attrs/title/html') {
      const node = workflowData.value.nodeList.find(n => n.id === cmd.data.id)
      const newTitle = cmd.data?.next?.attrs?.title?.text
      if (node && newTitle) {
        node.title = newTitle
      }
    }
    // 端口变化同步
    else if (cmd.event === 'cell:change:ports') {
      const portList = cmd.data?.next?.ports?.items
      if (portList) {
        handlePortChange(cmd.data.id, portList)
      }
    }
  })
})
```

**端口变化处理逻辑**:
```typescript
function handlePortChange(nodeId: string, portList: any) {
  const node = workflowData.value.nodeList.find(n => n.id === nodeId)
  if (node) {
    // 处理输出端口变化
    const outportList = portList.filter((p: any) => p.group === 'out')
    const nodeDataOutput = node.outputData
    const portIdList = outportList.map((p: any) => p.id)
    const nodeDataIdList = nodeDataOutput.map((p: any) => p.portId)
    
    // 删除不存在的端口数据
    nodeDataOutput.forEach((p: any) => {
      if (!portIdList.includes(p.portId)) {
        node.outputData.splice(node.outputData.indexOf(p), 1)
      }
    })
    
    // 按顺序添加新端口数据
    for (let i = 0; i < outportList.length; i++) {
      const port = outportList[i]
      if (!nodeDataIdList.includes(port.id)) {
        const portData = portMap.get(port.uniqueId)
        if (portData) {
          node.outputData.splice(i, 0, portData)
        }
      }
    }
    
    // 处理输入端口变化（撤销入桩点）
    const inportList = portList.filter((p: any) => p.group === 'in')
    const portInIdList = inportList.map((p: any) => p.id)
    node.inputData.forEach(item => {
      if (portInIdList.includes(item.portId)) {
        item.sourceType = 'node'
      } else {
        item.sourceType = 'input'
      }
    })
    
    // 重新更新节点高度
    onNodeDataUpdate(node)
  }
}
```

### 搜索模态框功能
**位置**: 通过emit事件与父组件通信

**功能特性**:
- 支持节点搜索和快速连接
- 支持从边添加新连接
- 支持端口级别的搜索
- 动态位置计算和显示
- 边连接时自动分配输入端口
- 选择变化时显示属性面板
- 支持撤销/重做操作的数据同步
- 端口变化时自动更新节点数据

## 代码生成

### Lua代码生成器
**位置**: `src/utils/json2lua/LuaGenerator.ts`

**生成流程**:
1. 收集所有需要的模块信息
2. 生成模块声明
3. 生成函数声明
4. 生成变量声明
5. 按执行顺序生成主流程代码
6. 生成返回语句
7. 生成模块导出

**特殊功能**:
- 支持迭代器代码块生成
- 支持决策表代码生成
- 支持外部数据表代码生成
- 支持自定义函数代码生成
- 支持测试脚本生成

### 工作流分析器
**位置**: `src/utils/json2lua/WorkflowAnalyzer.ts`

**分析内容**:
- 节点执行顺序（拓扑排序）
- 节点类型识别
- 层级计算
- 分支分析
- 汇合点处理
- 迭代器节点分析
- 分组节点分析

## 扩展指南

### 添加新节点类型
1. 在`NodeFactory.ts`中添加节点创建逻辑
2. 在`CustomNodeManager.ts`中添加节点配置生成逻辑
3. 在`WorkflowValidator.ts`中添加验证规则
4. 在`LuaGenerator.ts`中添加代码生成逻辑

### 添加新的验证规则
1. 在`WorkflowValidator.ts`中添加新的验证方法
2. 在`validate()`方法中调用新验证方法
3. 确保错误信息清晰明确

### 修改节点外观
1. 修改`CustomNodeManager.ts`中的配置生成逻辑
2. 调整端口布局算法
3. 更新CSS样式

### 添加新的插件
1. 在`X6Plugin.ts`中注册新插件
2. 配置插件参数
3. 处理插件事件

## 注意事项

### 性能考虑
- 大型工作流可能需要优化分析算法
- 考虑缓存分析结果
- 监控内存使用情况
- 使用批量操作减少重绘

### 调试建议
- 启用详细的分析日志
- 检查生成的Lua代码语法
- 验证数据流正确性
- 使用浏览器开发者工具调试

### 常见问题
- 循环依赖检测
- 类型兼容性验证
- 端口分配冲突
- 条件分支完整性
- 迭代器节点管理
- 分组节点嵌套

## 相关文档

- [工作流Lua代码生成器文档](./工作流Lua代码生成器文档.md)
- [函数编辑器交接文档](./函数编辑器交接文档.md)

## 更新日志

### v2.1.0 (当前版本)
- **拖拽面板优化**
  - 恢复左侧垂直布局设计
  - 支持触摸事件拖拽，适配移动端和平板端
  - 优化触摸事件处理，防止触发页面返回手势
  - 改进节点悬停提示功能
- **表达式编辑器优化**
  - BaseFunctionInput组件样式完全模拟el-input textarea
  - 优化Monaco Editor配置，关闭行号显示
  - 左侧margin区域宽度设为0，优化空间利用
  - 改进全屏编辑对话框体验

### v2.0.0
- 新增迭代器节点支持
  - 支持循环处理数据集合
  - 内置起始节点管理
  - 支持折叠/展开功能
  - 子节点位置自动同步
- 新增分组节点功能
  - 支持多节点逻辑分组
  - 分组可折叠/展开
  - 支持分组重命名
- 新增决策表编辑功能
  - Excel模板导入导出
  - 动态列管理
  - 表达式编辑器集成
- 新增外部数据表节点
  - 支持外部数据源配置
  - 动态参数选项
- 新增自定义函数节点
  - 支持用户自定义Lua代码
- 优化连接线样式管理
  - 基于距离的自动样式切换
  - 智能路由选择
- 增强工作流验证规则
  - 迭代器节点验证
  - 外部决策表验证
  - 全局变量引用验证
- 改进撤销/重做功能
  - 支持端口变化同步
  - 支持节点状态恢复
- 新增一键布局功能
  - 基于dagre的自动布局
- 优化节点复制粘贴功能
  - 支持迭代器节点复制
  - 自动处理子节点关系
- 新增工作流验证模态框
  - 错误分类显示
  - 快速节点定位
- 新增搜索模态框功能
  - 节点快速搜索
  - 边连接辅助
- 新增键盘快捷键支持
  - 分组操作快捷键
  - 复制粘贴快捷键
