import{d as ee,p as we,X as Ce,j as Se,r as g,b as xe,o as T,c as B,e as r,i,m as l,g as y,F as X,n as Ve,q as U,s as n,E as Z,f as o,u as Ne,Y as Ee,Z as Be,v as w,h as H,w as Q,l as Re,x as Ye}from"./index-1b7a9618.js";import{h,_ as Me}from"./_plugin-vue_export-helper-68e29187.js";import{D as Fe}from"./detail-7dd9329a.js";import{a as Le}from"./ruleCache-2bb6c17e.js";import{B as $e,a as Ue}from"./BaseTable-881e8777.js";import{u as He}from"./useDialogDrag-547cdc70.js";import"./_baseSlice-cf92e063.js";const Pe={class:"page"},ze={class:"name"},Ie={class:"dialog-footer"},qe={class:"dialog-footer"},Ae={class:"history-container"},Ke={class:"history-list"},Oe={class:"version-table"},Je={class:"table-header"},je={class:"header-cell"},Ge={class:"table-row"},We={class:"table-cell"},Xe={class:"table-cell"},Ze={class:"table-cell"},Qe={class:"table-cell"},et={class:"table-cell"},tt=ee({name:"rule"}),at=ee({...tt,setup(lt){const{initDialog:R}=He(),s=l({ruleType:"module"}),te=[{key:"keyword",label:"规则id/编码/名称/描述",fixed:!0,placeholder:"按id/编码/名称/描述搜索",keydownSearch:!0,labelWidth:"150px"},{key:"ruleType",label:"规则类型",type:"select",options:[],fixed:!0,clearable:!0,placeholder:"请选择规则类型"},{key:"sceneCategory",label:"业务场景",type:"select",options:[],fixed:!0,clearable:!0,placeholder:"请选择"},{key:"creatorName",label:"创建人",placeholder:"请输入创建人",fixed:!0},{key:"publisher",label:"发布人",placeholder:"请输入发布人"},{key:"publishTime",label:"发布时间",type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD HH:mm:ss",placeholder:"请选择"},{key:"modifierName",label:"修改人",placeholder:"请输入"},{key:"modifyTime",label:"修改时间",type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD HH:mm:ss",placeholder:"请选择"},{key:"variableSet",label:"参数代码",placeholder:"请输入参数代码code",clearable:!0},{key:"createTime",label:"创建时间",type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD HH:mm:ss",placeholder:"请选择"}],C=l({ruleType:[],sceneCategory:[]}),_=l(1),Y=l(10),P=l(0),z=l(),ae=l([{type:"primaryButton",label:"新增规则",onClick:ce},{type:"primaryButton",label:"刷新规则缓存",onClick:ge}]),le=[{type:"index",key:"index"},{key:"id",label:"规则id",width:"120"},{key:"ruleCode",label:"规则编码",width:"120"},{key:"ruleName",label:"规则名称",width:"160"},{key:"ruleType",label:"规则类型",width:"88",formatter:e=>j("ruleType",e.ruleType)},{key:"sceneCategory",label:"业务场景",width:"88",formatter:e=>j("sceneCategory",e.sceneCategory)},{key:"ruleDesc",label:"规则描述",width:"120",prependEditButton:!0,editButtonClick:e=>ve(e)},{key:"variableSet",label:"引用参数",width:"80",click:e=>Te(e.variableSet),formatter:e=>"查看"},{key:"ruleStatus",label:"状态",width:"100",type:"status",isSuccess:e=>e.ruleStatus==="ENABLED",successText:"启用",failText:"禁用"},{key:"publishCode",label:"当前运行版本号",width:"140",formatter:e=>V(e.publishTime)||"/"},{key:"publishTime",label:"发布时间",width:"160",formatter:e=>e.publishTime||"/"},{key:"publisher",label:"发布人",width:"100",formatter:e=>e.publisher||"/"},{key:"modifierCode",label:"最新版本号",width:"140",formatter:e=>V(e.modifyTime)||"/"},{key:"modifyTime",label:"修改时间",width:"160",formatter:e=>e.modifyTime||"/"},{key:"modifierName",label:"修改人",width:"100",formatter:e=>e.modifierName||"/"},{key:"creatorName",label:"创建人",width:"100",formatter:e=>e.creatorName||"/"},{key:"enableTime",label:"启用时间",width:"160",formatter:e=>e.enableTime||"/"},{key:"action",type:"action",label:"操作",fixed:"right",width:"180",formatter:e=>{if(e.ruleType==="module")return r(X,null,[r(g("el-button"),{link:!0,type:"primary",style:"padding: 0",onclick:()=>me(e)},{default:()=>[y("编辑")]}),r(g("el-button"),{link:!0,type:"primary",style:"padding: 0",onclick:()=>he(e)},{default:()=>[y("历史版本")]}),r(g("el-button"),{link:!0,type:"danger",style:"padding: 0",onclick:()=>ke(e)},{default:()=>[y("删除")]})])}}],M=l(!1);async function f(){var d,m,c,b,D,k,a,p;M.value=!0;const e={...s.value,pageNo:_.value,pageSize:Y.value};s.value.createTime&&(e.createTimeStart=((d=s.value.createTime)==null?void 0:d[0])||void 0,e.createTimeEnd=((m=s.value.createTime)==null?void 0:m[1])||void 0),s.value.publishTime&&(e.publishTimeStart=((c=s.value.publishTime)==null?void 0:c[0])||void 0,e.publishTimeEnd=((b=s.value.publishTime)==null?void 0:b[1])||void 0),s.value.modifyTime&&(e.modifyTimeStart=((D=s.value.modifyTime)==null?void 0:D[0])||void 0,e.modifyTimeEnd=((k=s.value.modifyTime)==null?void 0:k[1])||void 0);const t=await h.post({url:"rule-config/rule/page",data:e});z.value=((a=t.data)==null?void 0:a.rows)||[],P.value=((p=t.data)==null?void 0:p.total)||0,M.value=!1}const v=l(!1),I=l(""),oe=l(""),u=l({}),S=l("Edit"),q=we(),A=Ce(),K=Le(),re=l(!1),se=Ve({keyword:"",ruleType:"module",sceneCategory:"",ruleStatus:"",creatorName:"",createTimeRange:null,publisher:"",publishTimeRange:null,modifierName:"",modifyTimeRange:null,variableSet:""}),ie=l([]),ne=l([]),F=l(!1),L=l(!1),O=l([]),J=l(null);Se(()=>{var e;f(),ue(),(e=A.query)!=null&&e.searchkey&&setTimeout(()=>{se.keyword=A.query.searchkey,f()},200)});async function ue(){const{data:e}=await h.post({url:"/umas/common/dict/get",data:{codes:["RULE_TYPE","RULE_BUSINESS"]}});e.length>0&&(C.value.ruleType=[{value:"",name:"全部"},...e[0]],C.value.sceneCategory=[{value:"",name:"全部"},...e[1]],ie.value=[{value:"",name:"全部"},...e[0]],ne.value=[{value:"",name:"全部"},...e[1]])}const x=l();function de(){x.value.resetForm(),u.value={}}function ce(){S.value="ADD",I.value="新增规则",v.value=!0,u.value={ruleCode:"",ruleName:"",ruleType:"module",sceneCategory:"",ruleDesc:"",ruleStatus:"ENABLED"},U(()=>{R()})}function me(e){K.setCurrentRule(e),q.push({name:"ruleEdit",query:{ruleId:e.id}})}function pe(){x.value.validate(async e=>{e&&await h.post({url:"/rule-config/rule/add",data:{ruleCode:u.value.ruleCode,ruleName:u.value.ruleName,ruleType:u.value.ruleType,sceneCategory:u.value.sceneCategory,ruleDesc:u.value.ruleDesc,ruleStatus:u.value.ruleStatus}}).then(t=>{t.data>0?(n.success({message:"保存成功"}),v.value=!1,_.value=1,f()):n.error({message:"保存失败"})})})}const fe=async e=>{await h.post({url:"/rule-config/rule/add",data:e}).then(t=>{t.code===200&&(n.success({message:"保存成功"}),v.value=!1,_.value=1,f())})};function ye(){x.value.validate(async e=>{e&&await h.post({url:"/rule-config/rule/update/basic",data:u.value}).then(()=>{v.value=!1,n.success({message:"保存成功"}),_.value=1,f()})})}function j(e,t){const d=C.value[e].find(m=>m.value===t);return d?d.name:t}const V=e=>{if(!e)return"";const t=new Date(e),d=t.getFullYear(),m=(t.getMonth()+1).toString().padStart(2,"0"),c=t.getDate().toString().padStart(2,"0"),b=t.getHours().toString().padStart(2,"0"),D=t.getMinutes().toString().padStart(2,"0"),k=t.getSeconds().toString().padStart(2,"0");return`${d}${m}${c}${b}${D}${k}`},ve=e=>{oe.value="edit",u.value={...e},S.value="EDIT",v.value=!0,U(()=>{R()})};function ge(){Z.confirm("确定要刷新规则缓存吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{h.post({url:"/rule-config/rule/cache/refresh"}).then(e=>{e.data===!0?n.success("缓存刷新成功"):n.error("缓存刷新失败")}).catch(()=>{n.error("缓存刷新失败")})}).catch(()=>{})}async function he(e){J.value=e,F.value=!0,L.value=!0;try{const{data:t}=await h.post({url:"/rule-config/rule/history",data:{id:e.id}});O.value=t.map((d,m)=>({...d,isCurrent:m===0}))}catch(t){console.error("Failed to fetch history:",t),n.error("获取历史版本失败")}finally{L.value=!1}}function be(e){K.setCurrentRule(e),q.push({name:"ruleEdit",query:{ruleId:J.value.id}})}async function ke(e){try{await Z.confirm("确定要删除该规则吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await h.post({url:"/rule-config/rule/delete",data:{id:e.id}});t.success&&(!t.data||t.data.length===0)?(n.success("删除成功"),f()):t.data&&t.data.length>0?n.error("删除失败：该规则被引用，无法删除。引用信息："+JSON.stringify(t.data)):n.error("删除失败")}catch(t){t!=="cancel"&&(console.error("Delete rule error:",t),n.error("删除失败："+(t.message||"未知错误")))}}const N=l(!1),G=l([]),Te=e=>{G.value=JSON.parse(e)||[],N.value=!0,U(()=>{R()})},W=l(),E=l(""),_e=()=>{W.value.filter(E.value)},De=(e,t)=>e?t.code.includes(e):!0,$=()=>{E.value="",N.value=!1};return(e,t)=>{const d=g("el-input"),m=g("el-tree"),c=g("el-button"),b=g("el-dialog"),D=g("el-drawer"),k=xe("loading");return T(),B("div",Pe,[r($e,{params:te,"param-options":C.value,modelValue:s.value,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value=a),onSearch:f,onReset:f},null,8,["param-options","modelValue"]),r(Ue,{rowKey:"id",loading:M.value,emptyText:"未搜索到符合条件的数据",actions:ae.value,"table-data":z.value,"table-column":le,"current-page":_.value,"onUpdate:currentPage":t[1]||(t[1]=a=>_.value=a),"page-size":Y.value,"onUpdate:pageSize":t[2]||(t[2]=a=>Y.value=a),total:P.value,onGetList:f},null,8,["loading","actions","table-data","current-page","page-size","total"]),r(b,{modelValue:N.value,"onUpdate:modelValue":t[4]||(t[4]=a=>N.value=a),title:"引用参数",width:"400px",class:"variable-dialog","close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0,"destroy-on-close":!0,onClose:$},{footer:i(()=>[o("span",Ie,[r(c,{onClick:$},{default:i(()=>[...t[8]||(t[8]=[y("取消",-1)])]),_:1}),r(c,{type:"primary",onClick:$},{default:i(()=>[...t[9]||(t[9]=[y("确定",-1)])]),_:1})])]),default:i(()=>[r(d,{"prefix-icon":Ne(Ee),modelValue:E.value,"onUpdate:modelValue":t[3]||(t[3]=a=>E.value=a),placeholder:"搜索参数",onKeyup:Be(_e,["enter","native"])},null,8,["prefix-icon","modelValue"]),r(m,{ref_key:"treeRef",ref:W,"filter-node-method":De,style:{"max-height":"300px",overflow:"overlay","margin-top":"8px"},data:G.value,props:{children:"children"}},{default:i(({node:a,data:p})=>[o("span",ze,w(p.name?`${p.name}${p.level===1?` ID:${p.id}`:""}`:p.code),1)]),_:1},8,["data"])]),_:1},8,["modelValue"]),r(b,{modelValue:v.value,"onUpdate:modelValue":t[6]||(t[6]=a=>v.value=a),title:I.value,width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0,"destroy-on-close":!0,onClose:de},{footer:i(()=>[o("span",qe,[r(c,{onClick:t[5]||(t[5]=a=>v.value=!1)},{default:i(()=>[...t[10]||(t[10]=[y("取消",-1)])]),_:1}),S.value=="ADD"?(T(),H(c,{key:0,type:"primary",onClick:pe},{default:i(()=>[...t[11]||(t[11]=[y("确定",-1)])]),_:1})):(T(),H(c,{key:1,type:"primary",onClick:ye},{default:i(()=>[...t[12]||(t[12]=[y("确定",-1)])]),_:1}))])]),default:i(()=>[Q(r(Fe,{ref_key:"refDetail",ref:x,detail:u.value,"operation-mode":S.value,onSubmit:fe},null,8,["detail","operation-mode"]),[[k,re.value]])]),_:1},8,["modelValue","title"]),r(D,{modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=a=>F.value=a),title:"历史版本",direction:"rtl",size:"60%","close-on-click-modal":!1},{default:i(()=>[Q((T(),B("div",Ae,[o("div",Ke,[(T(!0),B(X,null,Re(O.value,(a,p)=>(T(),B("div",{key:p,class:"history-item"},[o("div",Oe,[o("div",Je,[o("div",je,w(a.isCurrent?"当前版本号":"版本号"),1),t[13]||(t[13]=o("div",{class:"header-cell"},"发布时间",-1)),t[14]||(t[14]=o("div",{class:"header-cell"},"发布人",-1)),t[15]||(t[15]=o("div",{class:"header-cell"},"修改记录",-1)),t[16]||(t[16]=o("div",{class:"header-cell"},"操作",-1))]),o("div",Ge,[o("div",We,w(V(a.publishTime)),1),o("div",Xe,w(V(a.publishTime)),1),o("div",Ze,w(a.modifierName||"/"),1),o("div",Qe,w(a.modifyReason),1),o("div",et,[a.isCurrent?Ye("",!0):(T(),H(c,{key:0,type:"primary",link:"",onClick:ot=>be(a),style:{color:"var(--el-color-primary) !important"}},{default:i(()=>[...t[17]||(t[17]=[y(" 打开 ",-1)])]),_:1},8,["onClick"]))])])])]))),128))])])),[[k,L.value]])]),_:1},8,["modelValue"])])}}});const mt=Me(at,[["__scopeId","data-v-20c9f022"]]);export{mt as default};
