import{h as w,_ as Be}from"./_plugin-vue_export-helper-68e29187.js";import{d as re,j as se,k as Fe,r as c,o as g,h as Y,i as u,e as a,c as k,l as Ie,F as ie,g as C,m as i,n as Ue,p as Le,b as Ae,q as le,E as oe,s as b,f as p,w as ne,u as ue,t as ze,v as D,x as W,y as Ge,z as $e}from"./index-1b7a9618.js";import{u as Me,a as Pe}from"./ruleCache-2bb6c17e.js";import{B as Re,a as Ye}from"./BaseTable-881e8777.js";import{u as qe}from"./useDialogDrag-547cdc70.js";import{g as Ke}from"./WorkFlowApi-e039841e.js";import"./_baseSlice-cf92e063.js";import"./DataOptimizer-aded8d7d.js";const He=re({__name:"detail",props:{detail:{type:Object,default:()=>({})},operationMode:{type:String,default:"ADD"},functionCateData:{type:Array,default:[]}},setup(Z,{expose:A}){const y=Z,x=i(),l=Ue({funcCode:"",funcName:"",funcCategory:"",funcDesc:"",functionStatus:"ENABLED",isGeometry:0,categoryId:""}),B=i([]),q={funcCode:[{required:!0,message:"请输入函数编码",trigger:"blur"},{max:50,message:"长度不能超过 50 个字符",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"只能输入英文、下划线和数字",trigger:"blur"},{validator:(n,o,f)=>{o&&o.trim()!==o&&(l.funcCode=o.trim()),f()},trigger:"blur"}],funcName:[{required:!0,message:"请输入函数名称",trigger:"blur"},{max:50,message:"长度不能超过 50 个字符",trigger:"blur"},{validator:(n,o,f)=>{o&&o.trim()!==o&&(l.funcName=o.trim()),f()},trigger:"blur"}],funcCategory:[{required:!0,message:"请选择函数类型",trigger:"change"}],funcDesc:[{required:!0,message:"请输入函数描述",trigger:"blur"},{max:250,message:"长度不能超过 250 个字符",trigger:"blur"},{validator:(n,o,f)=>{o&&o.trim()!==o&&(l.funcDesc=o.trim()),f()},trigger:"blur"}],functionStatus:[{required:!0,message:"请选择函数状态",trigger:"change"}],categoryId:[{required:!0,message:"请选择函数分类",trigger:"change"}],isGeometry:[{required:!0,message:"请选择是否几何函数",trigger:"change"}]};async function s(){const{data:n}=await w.post({url:"/umas/common/dict/get",data:{codes:["FUNCTION_TYPE"]}});n.length>0&&(B.value=n[0])}se(()=>{s()}),Fe(()=>y.detail,n=>{n&&(l.funcCode=n.funcCode||"",l.funcName=n.funcName||"",l.funcCategory=n.funcCategory||"",l.funcDesc=n.funcDesc||"",l.functionStatus=n.functionStatus||"ENABLED",l.categoryId=n.categoryId||"",l.isGeometry=n.isGeometry??0)},{immediate:!0});const F=n=>{var o;(o=x.value)==null||o.validate(f=>{f&&Object.assign(y.detail,{funcCode:l.funcCode.trim(),funcName:l.funcName.trim(),funcCategory:l.funcCategory,funcDesc:l.funcDesc.trim(),functionStatus:l.functionStatus,categoryId:l.categoryId,isGeometry:l.isGeometry}),n(f)})},z=()=>{var n;(n=x.value)==null||n.resetFields(),Object.assign(l,{funcCode:"",funcName:"",funcCategory:"",funcDesc:"",functionStatus:"ENABLED",isGeometry:0,categoryId:""})},E=n=>{l[n]&&typeof l[n]=="string"&&l[n].trim()!==l[n]&&(l[n]=l[n].trim())};return A({validate:F,resetForm:z}),(n,o)=>{const f=c("el-input"),h=c("el-form-item"),G=c("el-option"),K=c("el-select"),_=c("el-tree-select"),S=c("el-radio"),H=c("el-radio-group"),J=c("el-form");return g(),Y(J,{ref_key:"formRef",ref:x,model:l,rules:q,"label-width":"100px",class:"function-detail-form"},{default:u(()=>[a(h,{label:"函数编码",prop:"funcCode"},{default:u(()=>[a(f,{modelValue:l.funcCode,"onUpdate:modelValue":o[0]||(o[0]=d=>l.funcCode=d),placeholder:"请输入函数编码",disabled:y.operationMode==="EDIT",onBlur:o[1]||(o[1]=d=>E("funcCode"))},null,8,["modelValue","disabled"])]),_:1}),a(h,{label:"函数名称",prop:"funcName"},{default:u(()=>[a(f,{modelValue:l.funcName,"onUpdate:modelValue":o[2]||(o[2]=d=>l.funcName=d),placeholder:"请输入函数名称",onBlur:o[3]||(o[3]=d=>E("funcName"))},null,8,["modelValue"])]),_:1}),a(h,{label:"函数类型",prop:"funcCategory"},{default:u(()=>[a(K,{modelValue:l.funcCategory,"onUpdate:modelValue":o[4]||(o[4]=d=>l.funcCategory=d),placeholder:"请选择函数类型",style:{width:"100%"},disabled:y.operationMode==="EDIT"},{default:u(()=>[(g(!0),k(ie,null,Ie(B.value,d=>(g(),Y(G,{key:d.value,label:d.name,value:d.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(h,{label:"函数描述",prop:"funcDesc"},{default:u(()=>[a(f,{modelValue:l.funcDesc,"onUpdate:modelValue":o[5]||(o[5]=d=>l.funcDesc=d),type:"textarea",rows:4,placeholder:"请输入函数描述",onBlur:o[6]||(o[6]=d=>E("funcDesc"))},null,8,["modelValue"])]),_:1}),a(h,{label:"函数状态",prop:"functionStatus"},{default:u(()=>[a(K,{modelValue:l.functionStatus,"onUpdate:modelValue":o[7]||(o[7]=d=>l.functionStatus=d),placeholder:"请选择函数状态",style:{width:"100%"},disabled:y.operationMode!=="EDIT"},{default:u(()=>[a(G,{label:"启用(画布可显)",value:"ENABLED"}),a(G,{label:"下架(画布不显示)",value:"OFF_SHELVES"})]),_:1},8,["modelValue","disabled"])]),_:1}),a(h,{label:"函数分类:",prop:"categoryId"},{default:u(()=>[a(_,{modelValue:l.categoryId,"onUpdate:modelValue":o[8]||(o[8]=d=>l.categoryId=d),data:Z.functionCateData,"value-key":"id","render-after-expand":!1,style:{width:"240px"},props:{label:"name",value:"id"}},null,8,["modelValue","data"])]),_:1}),a(h,{label:"是否几何函数",prop:"isGeometry"},{default:u(()=>[a(H,{modelValue:l.isGeometry,"onUpdate:modelValue":o[9]||(o[9]=d=>l.isGeometry=d),style:{display:"flex","flex-direction":"row"}},{default:u(()=>[a(S,{label:0},{default:u(()=>[...o[10]||(o[10]=[C("否",-1)])]),_:1}),a(S,{label:1},{default:u(()=>[...o[11]||(o[11]=[C("是",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])}}});const Oe={class:"page"},je={class:"dialog-footer"},We={class:"dialog-header"},Ze={class:"header-content"},Je={class:"header-title"},Qe={key:0,class:"header-subtitle"},Xe={class:"rule-usage-content"},et={key:0,class:"usage-stats"},tt={class:"stats-content"},at={class:"stat-item"},lt={class:"stat-value"},ot={class:"stat-item"},nt={class:"stat-value"},ut={class:"table-container"},st={class:"rule-code"},rt={class:"rule-name"},it={class:"rule-desc"},dt={key:0},ct={key:1,class:"no-desc"},ft={key:0,class:"empty-state"},mt={key:1,class:"pagination-container"},pt={class:"dialog-footer"},gt=re({name:"function"}),yt=re({...gt,setup(Z){const{initDialog:A}=qe(),y=i(!1),x=i(""),l=i(1),B=i(10),q=i(0),s=i({}),F=i("Edit"),z=i(!1),E=i(!1),n=i({}),o=[{key:"keyword",label:"函数名称/描述/编码/ID",fixed:!0,placeholder:"按编码/名称/描述/ID搜索",keydownSearch:!0,labelWidth:"150px"},{key:"functionType",label:"函数类型",type:"select",options:[],fixed:!0,clearable:!0,placeholder:"请选择函数类型"},{key:"functionStatus",label:"状态",type:"select",clearable:!1,options:[{name:"全部",value:""},{name:"启用",value:"ENABLED"},{name:"禁用",value:"DISABLED"}],fixed:!0,placeholder:"请选择"},{key:"funcClassifyKeyword",label:"函数分类",type:"tree-select",options:[],fixed:!0,placeholder:"请选择",props:{label:"name",value:"id"}},{key:"creatorName",label:"创建人",placeholder:"请输入创建人"},{key:"createTime",label:"创建时间",type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD HH:mm:ss",placeholder:"请选择"},{key:"modifierName",label:"修改人",placeholder:"请输入"},{key:"modifyTime",label:"修改时间",type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",valueFormat:"YYYY-MM-DD HH:mm:ss",placeholder:"请选择"}],f=i({functionType:[],funcClassifyKeyword:[]}),h=i(),G=i([{type:"primaryButton",label:"新增函数",onClick:fe},{type:"primaryButton",label:"刷新函数缓存",onClick:he}]),K=[{type:"index",key:"index"},{key:"id",label:"函数id",width:"120"},{key:"funcCode",label:"函数编码",width:"140"},{key:"funcName",label:"函数名称",width:"160"},{key:"funcCategory",label:"函数类型",width:"88",formatter:e=>_e(e.funcCategory)},{key:"funcDesc",label:"函数描述",width:"120",prependEditButton:!0,editButtonClick:e=>me(e)},{key:"ruleUsage",label:"规则调用列表",width:"108",click:e=>we(e),formatter:e=>"查看",align:"center"},{key:"usageCount",label:"当前应用次数",width:"108",formatter:e=>e.usageCount||0,align:"center"},{key:"functionStatus",label:"状态",width:"140",type:"status-tag",isSuccess:e=>e.functionStatus==="ENABLED",successText:"启用(画布可显)",failText:"下架(画布不显示)",click:e=>be(e)},{key:"enableTime",label:"启用时间",width:"160",formatter:e=>X(e.enableTime)},{key:"creatorName",label:"创建人",width:"100",formatter:e=>e.creatorName},{key:"createTime",label:"创建时间",width:"160",formatter:e=>X(e.createTime)},{key:"modifierName",label:"修改人",width:"100",formatter:e=>e.modifierName},{key:"modifyTime",label:"修改时间",width:"160",formatter:e=>X(e.modifyTime)},{key:"action",type:"action",label:"操作",fixed:"right",width:"100",formatter:e=>a(ie,null,[a(c("el-button"),{link:!0,type:"primary",style:"padding: 0",onclick:()=>Ce(e)},{default:()=>[C("编辑")]}),a(c("el-button"),{link:!0,type:"danger",style:"padding: 0",onclick:()=>pe(e)},{default:()=>[C("删除")]})])}];async function _(){var m,T,v,V,N,L;E.value=!0;const e={...n.value,pageNo:l.value,pageSize:B.value,isMyFunction:S.value==="my"};n.value.createTime&&(e.createTimeStart=((m=n.value.createTime)==null?void 0:m[0])||void 0,e.createTimeEnd=((T=n.value.createTime)==null?void 0:T[1])||void 0),n.value.modifyTime&&(e.modifyTimeStart=((v=n.value.modifyTime)==null?void 0:v[0])||void 0,e.modifyTimeEnd=((V=n.value.modifyTime)==null?void 0:V[1])||void 0),n.value.funcClassifyKeyword&&(e.funcClassifyKeyword=f.value.funcClassifyKeyword.find(te=>te.id===n.value.funcClassifyKeyword).name);const t=await w.post({url:"rule-config/func/page",data:e});h.value=Array.isArray((N=t.data)==null?void 0:N.rows)?t.data.rows:[],q.value=typeof((L=t.data)==null?void 0:L.total)=="number"?t.data.total:0,E.value=!1}const S=i("all"),H=Le(),J=Me(),d=Pe(),$=i(!1),M=i(!1),Q=i([]),I=i(1),O=i(10),U=i(0),P=i(null);se(()=>{_(),ve()});const de=e=>{l.value=1,e.props.name==="my"?S.value="my":S.value="all",_()},j=i();function ce(){j.value.resetForm(),s.value={}}function fe(){F.value="ADD",x.value="新增函数",y.value=!0,s.value={funcCode:"",funcName:"",funcCategory:"",funcDesc:"",functionStatus:"ENABLED",isGeometry:0},le(()=>{A()})}async function me(e){F.value="EDIT",x.value="编辑函数",z.value=!0,y.value=!0;const{data:t}=await w.post({url:"/rule-config/func/detail",data:{id:e.id}});s.value=t,s.value.isGeometry===void 0&&(s.value.isGeometry=0),s.value.categoryId=s.value.categoryId+"",z.value=!1,le(()=>{A()})}async function pe(e){oe.confirm("确定要删除该函数吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{await w.post({url:"/rule-config/func/delete",data:{id:e.id}}).then(t=>{t.data===!0&&(b.success({message:"删除成功"}),_())})}).catch(()=>{})}function ge(){j.value.validate(async e=>{e&&await w.post({url:"/rule-config/func/add",data:{funcCode:s.value.funcCode,funcName:s.value.funcName,funcCategory:s.value.funcCategory,funcDesc:s.value.funcDesc,functionStatus:s.value.functionStatus,isGeometry:s.value.isGeometry,categoryId:s.value.categoryId}}).then(t=>{t.data===!0?(b.success({message:"保存成功"}),y.value=!1,l.value=1,_()):b.error({message:"保存失败"})})})}function ye(){j.value.validate(async e=>{e&&await w.post({url:"/rule-config/func/update",data:{id:s.value.id,funcCode:s.value.funcCode,funcName:s.value.funcName,funcCategory:s.value.funcCategory,funcDesc:s.value.funcDesc,functionStatus:s.value.functionStatus,isGeometry:s.value.isGeometry,categoryId:s.value.categoryId}}).then(t=>{t.data===!0?(b.success({message:"保存成功"}),y.value=!1,l.value=1,_()):b.error({message:"保存失败"})}).catch(t=>{b.error({message:t.message||"保存失败"})})})}async function ve(){const{data:e}=await w.post({url:"/umas/common/dict/get",data:{codes:["FUNCTION_TYPE"]}});e.length>0&&(f.value.functionType=[{value:"",name:"全部"},...e[0]])}function _e(e){const t=f.value.functionType.find(m=>m.value===e);return t?t.name:e}const be=e=>{const t=e.functionStatus==="ENABLED"?"OFF_SHELVES":"ENABLED",m=t==="ENABLED"?"启用（画布可显）":"下架（画布不可显）";oe.confirm(`确定要${m}该函数吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const T={data:{id:e.id,functionStatus:t}};w.post({url:"/rule-config/func/update/enable",data:T}).then(v=>{v.data===!0&&(b.success(`${m}成功`),_())})}).catch(()=>{})};function X(e){if(!e)return"";const t=new Date(e),m=t.getFullYear(),T=(t.getMonth()+1).toString().padStart(2,"0"),v=t.getDate().toString().padStart(2,"0"),V=t.getHours().toString().padStart(2,"0"),N=t.getMinutes().toString().padStart(2,"0"),L=t.getSeconds().toString().padStart(2,"0");return`${m}-${T}-${v} ${V}:${N}:${L}`}function Ce(e){J.setCurrentFunction(e),H.push({name:"functionEdit"})}function he(){oe.confirm("确定要刷新函数缓存吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{w.post({url:"/rule-config/rule/cache/refreshFunctions"}).then(e=>{e.data===!0?b.success("函数缓存刷新成功"):b.error("函数缓存刷新失败")}).catch(()=>{b.error("函数缓存刷新失败")})}).catch(()=>{})}async function we(e){P.value=e,$.value=!0,I.value=1,await ee(),le(()=>{A()})}async function ee(){var e,t;M.value=!0;try{const m=await w.post({url:"rule-config/func/useBy/rule",data:{funcId:P.value.id,pageNo:I.value,pageSize:O.value}});Q.value=Array.isArray((e=m.data)==null?void 0:e.rows)?m.data.rows:[],U.value=typeof((t=m.data)==null?void 0:t.total)=="number"?m.data.total:0}catch(m){console.error("Failed to fetch rule usage:",m),b.error("获取规则调用列表失败")}finally{M.value=!1}}function De(e){I.value=e,ee()}function ke(e){O.value=e,I.value=1,ee()}async function Se(e){d.setCurrentRule(e),H.push({name:"ruleEdit",query:{ruleId:e.id}})}function Te({row:e,rowIndex:t}){return t%2===0?"even-row":"odd-row"}async function Ne(){const e=await Ke();f.value.funcClassifyKeyword=e.data}return se(()=>{Ne()}),(e,t)=>{const m=c("el-tab-pane"),T=c("el-tabs"),v=c("el-button"),V=c("el-dialog"),N=c("el-icon"),L=c("el-card"),te=c("el-tag"),R=c("el-table-column"),xe=c("el-table"),Ee=c("el-empty"),Ve=c("el-pagination"),ae=Ae("loading");return g(),k("div",Oe,[a(T,{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=r=>S.value=r),onTabClick:de},{default:u(()=>[a(m,{label:"所有函数",name:"all"}),a(m,{label:"我创建的",name:"my"})]),_:1},8,["modelValue"]),a(Re,{params:o,"param-options":f.value,modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=r=>n.value=r),onSearch:_,onReset:_},null,8,["param-options","modelValue"]),a(Ye,{rowKey:"id",loading:E.value,emptyText:"未搜索到符合条件的数据",actions:G.value,"table-data":h.value,"table-column":K,"current-page":l.value,"onUpdate:currentPage":t[2]||(t[2]=r=>l.value=r),"page-size":B.value,"onUpdate:pageSize":t[3]||(t[3]=r=>B.value=r),total:q.value,onGetList:_},null,8,["loading","actions","table-data","current-page","page-size","total"]),a(V,{modelValue:y.value,"onUpdate:modelValue":t[5]||(t[5]=r=>y.value=r),title:x.value,width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1,"append-to-body":!0,"destroy-on-close":!0,onClose:ce},{footer:u(()=>[p("span",je,[a(v,{onClick:t[4]||(t[4]=r=>y.value=!1)},{default:u(()=>[...t[9]||(t[9]=[C("取消",-1)])]),_:1}),F.value=="ADD"?(g(),Y(v,{key:0,type:"primary",onClick:ge},{default:u(()=>[...t[10]||(t[10]=[C("确定",-1)])]),_:1})):(g(),Y(v,{key:1,type:"primary",onClick:ye},{default:u(()=>[...t[11]||(t[11]=[C("确定",-1)])]),_:1}))])]),default:u(()=>[ne(a(He,{ref_key:"refDetail",ref:j,detail:s.value,"operation-mode":F.value,functionCateData:f.value.funcClassifyKeyword},null,8,["detail","operation-mode","functionCateData"]),[[ae,z.value]])]),_:1},8,["modelValue","title"]),a(V,{modelValue:$.value,"onUpdate:modelValue":t[8]||(t[8]=r=>$.value=r),width:"85%","close-on-click-modal":!1,"append-to-body":"","destroy-on-close":!0,class:"rule-usage-dialog"},{header:u(()=>[p("div",We,[p("div",Ze,[p("div",Je,[a(N,{class:"title-icon"},{default:u(()=>[a(ue(ze))]),_:1}),t[12]||(t[12]=p("span",null,"规则调用列表",-1))]),P.value?(g(),k("div",Qe," 函数："+D(P.value.funcName)+" ("+D(P.value.funcCode)+") ",1)):W("",!0)])])]),footer:u(()=>[p("div",pt,[a(v,{onClick:t[7]||(t[7]=r=>$.value=!1),size:"large"},{default:u(()=>[a(N,null,{default:u(()=>[a(ue(Ge))]),_:1}),t[17]||(t[17]=C(" 关闭 ",-1))]),_:1})])]),default:u(()=>[ne((g(),k("div",Xe,[U.value>0?(g(),k("div",et,[a(L,{shadow:"never",class:"stats-card"},{default:u(()=>[p("div",tt,[p("div",at,[t[13]||(t[13]=p("span",{class:"stat-label"},"调用规则总数：",-1)),p("span",lt,D(U.value),1)]),p("div",ot,[t[14]||(t[14]=p("span",{class:"stat-label"},"当前页：",-1)),p("span",nt,D(I.value)+" / "+D(Math.ceil(U.value/O.value)),1)])])]),_:1})])):W("",!0),p("div",ut,[ne((g(),Y(xe,{data:Q.value,style:{width:"100%"},"header-cell-style":{"background-color":"#fafafa",color:"#606266","font-weight":"500"},"row-class-name":Te,"element-loading-text":"加载中...","element-loading-spinner":"el-icon-loading"},{default:u(()=>[a(R,{prop:"id",label:"规则ID",align:"center",width:"100"},{default:u(({row:r})=>[a(te,{size:"small",type:"info"},{default:u(()=>[C(D(r.id),1)]),_:2},1024)]),_:1}),a(R,{prop:"ruleCode",label:"规则编码",align:"center",width:"150"},{default:u(({row:r})=>[p("span",st,D(r.ruleCode),1)]),_:1}),a(R,{prop:"ruleName",label:"规则名称",align:"left","min-width":"200"},{default:u(({row:r})=>[p("span",rt,D(r.ruleName),1)]),_:1}),a(R,{prop:"ruleDesc",label:"规则描述",align:"left","min-width":"300","show-overflow-tooltip":""},{default:u(({row:r})=>[p("div",it,[r.ruleDesc?(g(),k("span",dt,D(r.ruleDesc),1)):(g(),k("span",ct,"暂无描述"))])]),_:1}),a(R,{label:"操作",align:"center",width:"120",fixed:"right"},{default:u(({row:r})=>[a(v,{type:"primary",size:"small",onClick:vt=>Se(r),class:"view-btn"},{default:u(()=>[a(N,null,{default:u(()=>[a(ue($e))]),_:1}),t[15]||(t[15]=C(" 查看 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,M.value]]),!M.value&&Q.value.length===0?(g(),k("div",ft,[a(Ee,{description:"暂无调用该函数的规则","image-size":120},{default:u(()=>[a(v,{type:"primary",onClick:t[6]||(t[6]=r=>$.value=!1)},{default:u(()=>[...t[16]||(t[16]=[C("关闭",-1)])]),_:1})]),_:1})])):W("",!0)]),U.value>0?(g(),k("div",mt,[a(Ve,{"current-page":I.value,"onUpdate:currentPage":De,"page-size":O.value,"onUpdate:pageSize":ke,"page-sizes":[10,20,30,40,50],layout:"total, sizes, prev, pager, next, jumper",total:U.value,background:"",class:"usage-pagination"},null,8,["current-page","page-size","total"])])):W("",!0)])),[[ae,M.value]])]),_:1},8,["modelValue"])])}}});const Tt=Be(yt,[["__scopeId","data-v-a11c2e2c"]]);export{Tt as default};
