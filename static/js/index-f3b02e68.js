import{b as $,c as F,T as P,d as M}from"./index-f946298d.js";import{f as V,h as z,_ as A}from"./_plugin-vue_export-helper-68e29187.js";import{B as O,a as j}from"./BaseTable-881e8777.js";import{d as H,j as J,s,o as Y,c as G,e as o,m as l,r as y,g as w,F as K}from"./index-1b7a9618.js";import"./WorkFlowApi-e039841e.js";import"./DataOptimizer-aded8d7d.js";import"./_baseSlice-cf92e063.js";const q={class:"page"},Q=H({__name:"index",setup(W){J(()=>{u(),E()});const g=l({}),S=[{key:"keyword",label:"关键词",fixed:!0,placeholder:"按id/编码/名称/描述搜索",keydownSearch:!0},{key:"ruleType",label:"规则类型",type:"select",fixed:!0,options:[],clearable:!0,placeholder:"请选择规则类型"},{key:"sceneCategory",label:"业务场景",type:"select",fixed:!0,options:[],clearable:!0,placeholder:"请选择"},{key:"ruleStatus",label:"状态",type:"select",clearable:!1,fixed:!0,options:[{value:"",name:"全部"},{name:"启用",value:"ENABLED"},{name:"禁用",value:"DISABLED"}],placeholder:"请选择"}],i=l({ruleType:[],sceneCategory:[]}),h=l(1),v=l(10),p=l(0),f=l(),D=l([{type:"primaryButton",label:"测试",onClick:R}]),T=[{type:"index",key:"index"},{key:"ruleId",label:"规则ID",width:"120"},{key:"ruleName",label:"规则名称",width:"160"},{key:"expectedResult",label:"预期结果",width:"120"},{key:"ruleType",label:"规则类型",width:"88",formatter:e=>x(i.value.ruleType,e.ruleType)},{key:"sceneCategory",label:"业务场景",width:"88",formatter:e=>x(i.value.sceneCategory,e.sceneCategory)},{key:"ruleStatus",label:"状态",width:"100",type:"status",isSuccess:e=>e.ruleStatus==="ENABLED",successText:"启用",failText:"禁用"},{key:"partId",label:"part节点ID",width:"160",formatter:e=>B(e)},{key:"executionResult",label:"执行结果",width:"140",type:"status",isSuccess:e=>N(e.executionResult),successText:"成功",failText:"失败",desc:e=>C(e.executionResult)},{key:"variableSet",label:"xml文件",width:"200",click:e=>b(e,"xml"),formatter:e=>e.fileCName},{key:"creatorName",label:"测试人员",width:"100",formatter:e=>e.creatorName||"/"},{key:"executionTime",label:"执行时长",width:"100",formatter:e=>V(e.executionTime)},{key:"modifyTime",label:"执行日期",width:"160",formatter:e=>_(e.modifyTime)},{key:"remark",label:"备注",width:"100",click:e=>b(e,"notes"),formatter:e=>"查看备注"},{key:"action",type:"action",label:"操作",fixed:"right",width:"200",formatter:e=>o(K,null,[o(y("el-button"),{link:!0,type:"primary",style:"padding: 0",onclick:()=>b(e)},{default:()=>[w("查看")]}),o(y("el-button"),{link:!0,type:"primary",style:"padding: 0",onclick:()=>L(e)},{default:()=>[w("下载xml文件")]}),o(y("el-popconfirm"),{title:"请确定要删除吗？","confirm-button-text":"好的","cancel-button-text":"不用了",width:"200","hide-after":"0",onConfirm:()=>U(e)},{reference:()=>o(y("el-link"),{type:"primary",style:"color: red;margin-left: 12px"},{default:()=>[w("删除")]})})])}],d=l(!1);async function E(){try{const e=await $({codes:["RULE_TYPE","RULE_BUSINESS"]});e.success&&e.data.length>=2&&(i.value.ruleType=[{value:"",name:"全部"},...e.data[0]],i.value.sceneCategory=[{value:"",name:"全部"},...e.data[1]])}catch(e){console.error("获取字典数据失败:",e)}}async function u(){d.value=!0;const e={...g.value,pageNo:h.value,pageSize:v.value};F(e).then(t=>{t.success?(f.value=t.data.rows,p.value=t.data.total||0):(s.error(t.error||"查询失败"),f.value=[],p.value=0,d.value=!1)}).catch(t=>{s.error((t==null?void 0:t.message)||"查询失败"),f.value=[],p.value=0,d.value=!1}).finally(()=>{d.value=!1})}function x(e,t){if(!t||!e||e.length===0)return"-";const a=e.find(c=>c.value===t);return a?a.name:"-"}function _(e){if(!e)return"-";try{const t=new Date(e),a=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),m=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),I=String(t.getSeconds()).padStart(2,"0");return`${a}-${c}-${r}
${m}:${n}:${I}`}catch(t){return console.error("格式化日期时间失败:",t),"-"}}function N(e){if(!e)return!1;try{return JSON.parse(e).success===!0}catch(t){return console.error("解析执行结果失败:",t),!1}}function C(e){if(!e)return"";try{return JSON.parse(e).message||""}catch(t){return console.error("解析执行结果失败:",t),""}}function B(e){const t=e.partName||"",a=e.partId||"";return t&&a?`${t} / ${a}`:a||t||""}function b(e,t){k.value.openDrawer(e,!0,!1,t,!0)}const k=l();function R(){k.value.openDrawer(null,!1,!1,"xml",!0)}async function L(e){if(e.ossPath)try{const t=await z.post({url:"/cloudstorage/sign",data:{signType:1,key:e.ossPath}});if(!t.success)throw new Error("获取下载链接失败");const a=t.data,c=e.fileCName||"未命名文件.xml";fetch(a).then(r=>{if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.blob()}).then(r=>{const m=window.URL.createObjectURL(r),n=document.createElement("a");n.href=m,n.download=c,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(m),s.success(`文件下载成功: ${c}`)}).catch(r=>{console.error("下载文件失败:",r),s.error("下载文件失败")})}catch(t){console.error("获取下载链接失败:",t),s.error("获取下载链接失败")}else s.warning("该记录没有关联的文件")}async function U(e){(await M({id:e.id})).success&&(s.success("删除成功"),u())}return(e,t)=>(Y(),G("div",q,[o(O,{params:S,"param-options":i.value,modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value=a),onSearch:u,onReset:u},null,8,["param-options","modelValue"]),o(j,{rowKey:"id",loading:d.value,emptyText:"未搜索到符合条件的数据",actions:D.value,"table-data":f.value,"table-column":T,"current-page":h.value,"onUpdate:currentPage":t[1]||(t[1]=a=>h.value=a),"page-size":v.value,"onUpdate:pageSize":t[2]||(t[2]=a=>v.value=a),total:p.value,onGetList:u},null,8,["loading","actions","table-data","current-page","page-size","total"]),o(P,{onClose:u,ref_key:"testDrawerRef",ref:k},null,512)]))}});const oe=A(Q,[["__scopeId","data-v-17968de8"]]);export{oe as default};
