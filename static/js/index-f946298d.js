var Jt=Object.defineProperty;var Ut=(v,e,t)=>e in v?Jt(v,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):v[e]=t;var k=(v,e,t)=>(Ut(v,typeof e!="symbol"?e+"":e,t),t);import{_ as Wt,d as pt,bg as Kt,o as L,c as z,f as h,v as q,m as I,aK as lt,k as ye,j as qt,aP as Ht,r as Y,h as Q,e as p,i as _,u as S,bh as ge,B as O,C as me,y as ie,x as Z,T as Yt,g as qe,F as Pe,l as He,aL as de,K as fe,D as De,bi as it,b3 as ct,bj as ut,E as Qt,s as T}from"./index-1b7a9618.js";import{_ as ht,h as ae,f as dt}from"./_plugin-vue_export-helper-68e29187.js";import{a as Zt,t as ea}from"./WorkFlowApi-e039841e.js";var R=(v=>(v.IFELSE="if_else",v.GLOBAL_PARAM="global_param",v.GLOBAL_VARIABLE="global_variable",v.TYPE_CONVERTER="type_converter",v.DIMENSION_CONVERTER="dimension_converter",v.CALCULATOR="calculator",v))(R||{});const Vs=v=>v.shape==="customNode",te=v=>{var e;return v&&v.funcType==="logic"&&((e=v.logicData)==null?void 0:e.logicType)===R.IFELSE},ta=v=>{var e;return v&&v.funcType==="logic"&&((e=v.logicData)==null?void 0:e.logicType)===R.CALCULATOR};class aa{constructor(e){k(this,"workflow");k(this,"nodeAnalysis");k(this,"branchInfoMap");k(this,"nodeBranchMap");k(this,"branchNodeCache");k(this,"globalVarMapPath");k(this,"mergePointCache");k(this,"nodeMap");k(this,"outEdgeMap");k(this,"inEdgeMap");k(this,"diffMergePointCache");k(this,"executionOrderResult");this.workflow=e,this.nodeAnalysis=new Map,this.branchInfoMap=new Map,this.nodeBranchMap=new Map,this.branchNodeCache=new Map,this.mergePointCache=new Map,this.globalVarMapPath=new Map,this.nodeMap=new Map,this.outEdgeMap=new Map,this.inEdgeMap=new Map,this.diffMergePointCache=new Map}clear(){this.workflow=null,this.nodeAnalysis.clear(),this.branchInfoMap.clear(),this.nodeBranchMap.clear(),this.branchNodeCache.clear(),this.mergePointCache.clear(),this.nodeMap.clear(),this.outEdgeMap.clear(),this.inEdgeMap.clear(),this.diffMergePointCache.clear(),this.globalVarMapPath.clear()}getNodeAnalysisType(e){return te(e)?"condition":"normal"}analyze(){this.initNodeMap(),this.executionOrderResult=this.generateExecutionOrder();let e=this.executionOrderResult.main;return this.initNodeLevel(e),this.assignNodeToBranch(),this.processMergePoints(),e=this.processGlobalVarPath(e),this.processDifferentSourceMerge(),this.printAnalysis(),{nodeAnalysis:this.nodeAnalysis,branchInfoMap:this.branchInfoMap,nodeBranchMap:this.nodeBranchMap,executionOrder:e}}initNodeLevel(e){for(const t of e){const s=this.nodeAnalysis.get(t);s.level=this.calculateNodeLevel(t)}}initNodeMap(){for(const e of this.workflow.nodeList){this.nodeMap.set(e.id,e),this.outEdgeMap.set(e.id,[]),this.inEdgeMap.set(e.id,[]);const t=this.getNodeAnalysisType(e);this.nodeAnalysis.set(e.id,{type:t,level:0}),t==="condition"&&this.buildBranchBase(e)}for(const e of this.workflow.edges)this.inEdgeMap.has(e.target)&&this.inEdgeMap.get(e.target).push(e),this.outEdgeMap.has(e.source)&&this.outEdgeMap.get(e.source).push(e)}syncNodeBranchMapWithPath(e,t){const s=this.branchInfoMap.get(e);if(s)for(const a of t)this.nodeBranchMap.set(a,s)}calculateNodeLevel(e){const t=this.inEdgeMap.get(e)||[];if(t.length===0)return 0;let s=0;for(const a of t){const n=this.nodeAnalysis.get(a.source);if(n){let l=n.level;n.type==="condition"&&l++,l>s&&(s=l)}}return s}buildBranchBase(e){const t=this.workflow.edges.filter(s=>s.source===e.id);if(t.sort((s,a)=>{const n=Number(s.sourcePort.split("_")[1]),l=Number(a.sourcePort.split("_")[1]);return n-l}),t.length>2){const s=t.splice(1,1)[0];t.push(s)}t.forEach((s,a)=>{const n=a===0?"if":a===t.length-1?"else":"elseif",l=`${e.id}_${s.sourcePort}`,i={logicNodeId:e.id,branchType:n,branchIndex:a,condition:"",nodes:[],exitNodes:[]};this.branchInfoMap.set(l,i)})}resetExitNodes(e){e.nodes.length>0?e.exitNodes=[e.nodes[e.nodes.length-1]]:e.exitNodes=[]}assignNodeToBranch(){this.branchInfoMap.forEach((e,t)=>{const s=this.collectBranchPathByEdges(t);s.length>0&&(e.nodes=s,this.resetExitNodes(e),this.syncNodeBranchMapWithPath(t,s))})}processGlobalVarPath(e){const t=Array.from(this.nodeMap.values()).filter(s=>{var a;return s.funcType==="logic"&&((a=s.logicData)==null?void 0:a.logicType)===R.GLOBAL_VARIABLE});if(t){t.forEach(a=>{this.findGlobalVarMergePoints(a.id,[a.id])});const s=new Set;return this.globalVarMapPath.forEach(a=>{a.forEach(n=>{const l=n.split(",");l.length>0&&l.forEach(i=>{s.add(i)})})}),e.filter(a=>!s.has(a))}return e}findGlobalVarMergePoints(e,t){const s=this.outEdgeMap.get(e)||[];for(const a of s){const n=a.target,l=this.nodeAnalysis.get(n);if(l&&(l!=null&&l.isMergePoint))this.globalVarMapPath.set(n,t);else{const i=[...t,n];this.findGlobalVarMergePoints(n,i)}}}processMergePoints(){Array.from(this.nodeMap.values()).filter(t=>{var s;return((s=this.inEdgeMap.get(t.id))==null?void 0:s.length)>1}).forEach(t=>{const s=this.inEdgeMap.get(t.id)||[],a=[],n=[],l={},i=[];s.forEach(g=>{const m=this.findNearestIfElseBranchId(g.source,g.sourcePort);m&&a.push(m.nearestId);const b=this.findRootIfElseBranchIdByNodeId(g.source);b&&!n.includes(b)&&n.push(b),b&&i.push(b),m&&(l[m.nearestId]=g.source,m.allIds.forEach(G=>{const $=this.nodeAnalysis.get(G);if($&&$.branchSourceMap)for(const[se,M]of Object.entries($.branchSourceMap))l[se]=g.source}))});const u=this.nodeAnalysis.get(t.id);u.isMergePoint=!0,u.localBranches=a,u.rootBranches=n,u.branchSourceMap=l,i.length>1?n.length==1?(u.isSameSourceMergePoint=!0,u.isDifferentSourceMergePoint=!1):(u.isSameSourceMergePoint=!1,u.isDifferentSourceMergePoint=!0):(u.isSameSourceMergePoint=!1,u.isDifferentSourceMergePoint=!1)})}findNearestIfElseBranchId(e,t,s=[]){const a=this.nodeMap.get(e);if(s.push(e),te(a)&&t)return{nearestId:`${e}_${t}`,allIds:s};const n=this.inEdgeMap.get(e)||[];for(const l of n){const i=this.findNearestIfElseBranchId(l.source,l.sourcePort,s);if(i)return i}return null}findRootIfElseBranchIdByNodeId(e){let t=null;const s=this.nodeMap.get(e);te(s)&&(t=e);const a=this.inEdgeMap.get(e)||[];for(const n of a){const l=this.findRootIfElseBranchIdByNodeId(n.source);l&&(!t||l!==t)&&(t=l)}return t}printAnalysis(){const e=Array.from(this.nodeAnalysis.entries()).filter(([t,s])=>s.isMergePoint);e.length===0||e.forEach(([t,s])=>{s.localBranches,s.rootBranches,s.isSameSourceMergePoint||s.isDifferentSourceMergePoint}),this.workflow.nodeList.forEach(t=>{const s=this.nodeAnalysis.get(t.id);s&&(t.id.toString().padEnd(8),t.title.padEnd(16),s.type.padEnd(8),(s.level+"").padEnd(4))}),this.branchInfoMap.forEach((t,s)=>{});for(const[t,s]of Object.entries(this.executionOrderResult));this.globalVarMapPath.size===0||this.globalVarMapPath.forEach((t,s)=>{})}topologicalSort(e,t){const s=new Map,a=new Map;for(const i of e)s.set(i,0),a.set(i,[]);for(const i of t)s.set(i.target,(s.get(i.target)||0)+1),a.has(i.source)&&a.get(i.source).push(i.target);const n=[],l=[];for(const[i,u]of s)u===0&&n.push(i);for(;n.length>0;){const i=n.shift();l.push(i);const u=a.get(i)||[];for(const g of u){const m=(s.get(g)||1)-1;s.set(g,m),m===0&&n.push(g)}}return l}generateExecutionOrder(){const e=[...this.workflow.nodeList.map(n=>n.id)],t=this.topologicalSort(e,this.workflow.edges),s=[],a={main:[]};for(const n of t)this.nodeAnalysis.get(n),s.push(n);return a.main=s,a}getBranchStartNodes(e){const t=e.split("_")[0],s=e.substring(t.length+1);return(this.outEdgeMap.get(t)||[]).filter(n=>n.sourcePort===s).map(n=>n.target)}traverseFromNode(e,t,s,a){if(s.has(e))return;s.add(e),t.push(e);const n=this.nodeAnalysis.get(e);if(n&&n.type==="condition")return;const l=this.outEdgeMap.get(e)||[];for(const i of l)this.traverseFromNode(i.target,t,s,a)}collectBranchPathByEdges(e){const t=[],s=new Set,a=this.getBranchStartNodes(e);for(const n of a)this.traverseFromNode(n,t,s,e);return s.clear(),t}resetNodeLevel(e){const t=this.outEdgeMap.get(e)||[],s=[];t.forEach(a=>{const n=this.nodeMap.get(a.target);if(n){const l=this.nodeAnalysis.get(n.id);l&&(l.level=this.calculateNodeLevel(n.id))}s.push(n.id)}),s.length>0&&s.forEach(a=>{this.resetNodeLevel(a)})}collectDescendants(e,t=new Set){const s=this.outEdgeMap.get(e)||[],a=this.nodeAnalysis.get(e);if(a&&a.type==="condition")return t.add(e),Array.from(t);for(const n of s){const l=this.nodeAnalysis.get(n.target);if(l&&l.isDifferentSourceMergePoint)continue;const i=n.target;t.has(i)||(t.add(i),this.collectDescendants(i,t))}return Array.from(t)}processDifferentSourceMerge(){Array.from(this.nodeAnalysis.entries()).filter(([t,s])=>s.isDifferentSourceMergePoint).forEach(([t,s])=>{s.level=1,this.resetNodeLevel(t),this.branchInfoMap.forEach((a,n)=>{a.nodes.includes(t)&&a.nodes.indexOf(t)>0&&(a.nodes=a.nodes.slice(0,a.nodes.indexOf(t)),this.resetExitNodes(a))}),this.diffMergePointCache.set(t,this.collectDescendants(t))})}isDifferentMerge(e){return this.diffMergePointCache.has(e)}getFlagDeclarations(){if(this.diffMergePointCache.size==0)return[];const e=[];for(const t of this.branchInfoMap.keys())e.push(`flag_${t}`);return e}getMergeDeclarations(){const e=[];let t=0;return this.diffMergePointCache.forEach((s,a)=>{t++;const n=this.nodeAnalysis.get(a);if(n!=null&&n.rootBranches&&n.rootBranches.length>0){const l=n.rootBranches.sort().join("_");e.push(`merge_${l}_${t}`)}}),e}getNodeById(e){return this.nodeMap.get(e)}getNodeOutEdge(e){return this.outEdgeMap.get(e)||[]}getNodeInput(e){return this.inEdgeMap.get(e)||[]}getFullExecutionOrder(){return this.executionOrderResult}getGlobalVarMapPath(){return this.globalVarMapPath}}class E{static indent(e){return this.indentCache.has(e)||this.indentCache.set(e,"	".repeat(e)),this.indentCache.get(e)}static getNodeVarName(e){return te(e)?`tempResult_${e.id}`:`result_${e.id}`}static getFuncVarName(e,t="out",s=1){return`${this.functionPrefix}_${e.id}_${t}_${s}`}}k(E,"indentCache",new Map),k(E,"functionPrefix","function");class sa{constructor(){}generateCode(e,t){let s="";const a=this.getGlobalParamType(e);if(!a)return s;const n=E.getNodeVarName(e);return s+=`${E.indent(t)}${n} = ${a}
`,s+=`${E.indent(t)}log("全局参数：获取节点 ${e.id} 的结果", ${n})

`,s}getGlobalParamType(e){return e.inputData[0].source}}class oa{constructor(){}generateCode(e,t,s){var g;let a="";const n=(g=e.inputData)==null?void 0:g.find(m=>m.paramName==="nodeId");if(!n)return a;const l=E.getNodeVarName(e),i=n.source||n.defaultValue,u=s.getNodeById(i);return u&&(a+=`${E.indent(t)}${l} = ${E.getNodeVarName(u)}
`,a+=`${E.indent(t)}log("全局变量：获取节点 ${e.id} 的结果", ${l})

`),a}}class na{constructor(){k(this,"paramNameResolver")}generateCode(e,t,s){var G,$;let a="";const n=(G=e.inputData)==null?void 0:G.find(se=>se.paramName==="data"),l=($=e.inputData)==null?void 0:$.find(se=>se.paramName==="convertType");if(!n||!l)return a;const i=E.getNodeVarName(e),u=n.source,g=this.paramNameResolver(u,s),m=l.source?l.source:l.defaultValue;let b=E.indent(t);switch(a+=`${b}-- 类型转换：${m}
`,a+=`${b}${i} = nil
`,a+=`${b}if ${g} ~= nil then
`,m){case"toString":a+=`${b}	if type(${g}) == "table" then
`,a+=`${b}		${i} = '' -- 不能将table的值 转成其他基础类型
`,a+=`${b}	else
`,a+=`${b}		${i} = tostring(${g})
`,a+=`${b}	end
`;break;case"toNumber":a+=`${b}	if type(${g}) == "table" then
`,a+=`${b}		${i} = 0 -- 不能将table的值 转成其他基础类型
`,a+=`${b}	else
`,a+=`${b}		${i} = tonumber(${g})
`,a+=`${b}	end
`;break;case"toBoolean":a+=`${b}	${i} = ${g} and true or false
`;break;default:a+=`${b}	${i} = {}
`,a+=`${b}	table.insert(${i}, ${g})
`;break}return a+=`${b}end
`,a}}class ra{constructor(){k(this,"paramNameResolver")}generateCode(e,t,s){var se,M,ue;let a="";const n=(se=e.inputData)==null?void 0:se.find(B=>B.paramName==="data"),l=(M=e.inputData)==null?void 0:M.find(B=>B.paramName==="option"),i=(ue=e.inputData)==null?void 0:ue.find(B=>B.paramName==="expression");if(!n||!l)return a;const u=E.getNodeVarName(e),g=n.source,m=this.paramNameResolver(g,s),b=l.source?l.source:l.defaultValue,G=(i==null?void 0:i.source)||"";let $=E.indent(t);switch(a+=`${$}-- 升维/降维操作：${b}
`,a+=`${$}${u} = nil
`,a+=`${$}if ${m} ~= nil then
`,b){case"upgrade":a+=`${$}	${u} = {}
`,a+=`${$}	table.insert(${u}, ${m})
`;break;case"downgrade_filter":a+=`${$}	${u} = {}
`,a+=`${$}	if type(${m}) == "table" and #${m} > 0 then
`,G?(a+=`${$}		for i, item in ipairs(${m}) do
`,a+=`${$}			if expression_${e.id}_in_3(item) then
`,a+=`${$}				table.insert(${u}, item)
`,a+=`${$}			end
`,a+=`${$}		end
`,a+=`${$}		if #${u} > 0 then
`,a+=`${$}			${u} = ${u}[1]
`,a+=`${$}		end
`):a+=`${$}		${u} = ${m}[1]
`,a+=`${$}	end
`;break;case"downgrade_extract":a+=`${$}	${u} = {}
`,a+=`${$}	if type(${m}) == "table" then
`,G?a+=`${$}		${u} = expression_${e.id}_in_3(${m})
`:a+=`${$}		${u} = ${m}[1]
`,a+=`${$}	end
`;break;case"toString":a+=`${$}	if type(${m}) == "table" then
`,a+=`${$}		${u} = '' -- 不能将table的值 转成其他基础类型
`,a+=`${$}	else
`,a+=`${$}		${u} = tostring(${m})
`,a+=`${$}	end
`;break;case"toNumber":a+=`${$}	if type(${m}) == "table" then
`,a+=`${$}		${u} = 0 -- 不能将table的值 转成其他基础类型
`,a+=`${$}	else
`,a+=`${$}		${u} = tonumber(${m})
`,a+=`${$}	end
`;break;case"toBoolean":a+=`${$}	${u} = ${m} and true or false
`;break}return a+=`${$}end
`,a}}class la{constructor(){}generateCode(e,t,s){let a="";if(!e.outputData[0].functionCode)return a+=`
${E.indent(t)}-- 错误：节点 ${e.id} 缺少必要的输出参数 ------------------

`,a;const l=E.getNodeVarName(e),i=E.getFuncVarName(e);let u=s.map(g=>g.value).join(", ");return a+=`${E.indent(t)}${l} = ${i}(${u}) 
`,a+=`${E.indent(t)}log("计算器：获取节点 ${e.id} 的结果", ${l})

`,a}}class ia{constructor(){k(this,"workflow");k(this,"funcData");k(this,"modules");k(this,"codeMap");k(this,"analyzer");k(this,"nodeAnalysis");k(this,"branchInfoMap");k(this,"executionOrder");k(this,"globalParam");k(this,"globalVariable");k(this,"typeConverter");k(this,"dimensionConverter");k(this,"calculator");k(this,"hasDiffMerge");k(this,"isGenerateTestLuaScript",!0);const e=(t,s)=>this.getArgParamNameForLogic(t,s);this.globalParam=new sa,this.globalVariable=new oa,this.typeConverter=new na,this.typeConverter.paramNameResolver=e,this.dimensionConverter=new ra,this.dimensionConverter.paramNameResolver=e,this.calculator=new la,this.modules=new Map}generate(e,t,s){this.clear(),this.workflow=e,this.funcData=t,this.codeMap=s,this.analyzer=new aa(e);const a=this.analyzer.analyze();this.nodeAnalysis=a.nodeAnalysis,this.branchInfoMap=a.branchInfoMap,this.executionOrder=a.executionOrder;const n=this.doGenerate();return this.clear(),n}clear(){this.workflow=null,this.funcData=null,this.modules.clear(),this.executionOrder=[],this.nodeAnalysis&&this.nodeAnalysis.clear(),this.branchInfoMap&&this.branchInfoMap.clear(),this.analyzer&&this.analyzer.clear(),this.hasDiffMerge=!1}doGenerate(){this.collectModules();let e="";return e+=this.generateModuleDeclarations(),e+=this.generateFunctionCode(),e+=`function work(root, context) {
`,e+=this.generateVariableDeclarations(),e+=this.generateMainFlow(),e+=this.generateReturnStatement(),e+=`}
`,e}collectModules(){this.workflow.nodeList.forEach(e=>{if(e.funcId){const t=this.funcData.find(s=>s.funcId==e.funcId);if(t){const s=`${t.path}/${t.className}`;this.modules.set(s,{path:t.path,name:t.className,func:t.funcName})}}})}generateModuleDeclarations(){let e=`
// 声明函数通用日志模块
`;return e+=`const log = console.log
`,e+=`const warn = console.warn
`,e+=`const error = console.error
`,e+=`
`,e}generateFunctionCode(){let e=`// 声明表达式所有变量
`;return Object.keys(this.codeMap).forEach(t=>{const s=t.split("_")[0];this.analyzer.getNodeById(s);const a=this.getNodeIncomingEdges(s),n=this.codeMap[t].includes("data")?a.map(g=>g.key).join(", "):"target",l=`
  `,i=`
    `,u=this.codeMap[t].trim()?`return (${this.codeMap[t].trim().split(`
`).map(g=>i+g).join("")}${l})(${n})`:"return ''";e+=`const ${E.functionPrefix}_${t} = (${n}) => {${l}${u} 
}`,e+=`

`}),e}generateVariableDeclarations(){let e=`	// 声明所有变量
`;const t=new Set;return this.workflow.nodeList.forEach(s=>{const a=te(s)?`tempResult_${s.id}`:`result_${s.id}`;t.has(a)||(e+=`	let ${a} = null
`,t.add(a))}),e+=`
`,e}generateMainFlow(){let e="",t=0;for(const s of this.executionOrder){const a=this.nodeAnalysis.get(s);if(a)if(a.level===0){const n=this.analyzer.getNodeById(s);n&&(te(n)?e+=this.generateIfElseBlock(n,1,new Set):e+=this.generateNodeCode(n,1,new Set))}else a.level===1&&this.analyzer.isDifferentMerge(s)&&(e+=this.generateDifferentSourceMergeBlock(s,t),t++)}return e}getNodeVarName(e,t=!1){return t?`tempResult_${e}`:`result_${e}`}getNodeIncomingEdges(e){const t=(this.workflow.edges||[]).filter(l=>l.target===e);if(!t.length)return console.warn(`[LuaGen] 节点 ${e} 没有找到输入节点`),[];const s=t.map(l=>l.source),a=[];s.forEach(l=>{this.resolveParamSourceAll(l).forEach(u=>{a.push(this.getNodeVarName(u))})});const n=[];return a.forEach((l,i)=>{const u=i===0?"data":`data${i}`;n.push({key:u,value:l})}),n}generateConditionExpression(e,t=0,s){var a;try{const n=(a=e.outputData)==null?void 0:a[t];if(!(n!=null&&n.functionCode))return"true";const l=this.getNodeIncomingEdges(e.id);if(e.version&&e.version>"1.0.0"){let i=l.map(u=>u.value).join(", ");return`expression_${s}_${n.portId}(${i})`}else{let i=n.functionCode;for(let u=l.length-1;u>=0;u--){const{key:g,value:m}=l[u],b=new RegExp(`\\b${g}\\b`,"g");i=i.replace(b,m)}return i=i.replace(/&&/g,"and").replace(/\|\|/g,"or").replace(/===/g,"==").replace(/!==/g,"~="),i}}catch(n){return console.error("[LuaGen] 生成条件表达式失败:",n),""}}generateIfElseBlock(e,t,s,a){try{const n=e.id;let l=`${E.indent(t)}-- 条件分支 ${n}
`;this.isGenerateTestLuaScript&&l&&this.shouldRecordLogicNode(e)&&(l+=`${E.indent(t)}exec.logic_and_log(func_step_logs, ${n}, '条件分支')
`);const i=[];return this.branchInfoMap.forEach((u,g)=>{g.split("_")[0]===n&&i.push({...u,branchId:g})}),i.forEach((u,g)=>{if(u.branchType==="if"?l+=`${E.indent(t)}if ${this.generateConditionExpression(e,g,n)} then
`:u.branchType==="elseif"?l+=`${E.indent(t)}elseif ${this.generateConditionExpression(e,g,n)} then
`:l+=`${E.indent(t)}else
`,u.nodes.forEach(m=>{const b=this.analyzer.getNodeById(m);b&&(l+=this.generateNodeCode(b,t+1,s,u))}),this.hasDiffMerge){const m=`flag_${u.branchId}`;l+=`${E.indent(t+1)}${m} = true
`}if(u.exitNodes.length>0){const m=u.exitNodes[0],b=this.analyzer.getNodeById(m);if(b){const G=te(b);this.analyzer.getNodeOutEdge(m).length>0?l+=`${E.indent(t+1)}${this.getNodeVarName(n,!0)} = ${this.getNodeVarName(m,G)}
`:l+=`${E.indent(t+1)}return ${this.getNodeVarName(m,G)}
`}}}),l+=`${E.indent(t)}end
`,l}catch(n){return console.error("[LuaGen] 生成 if-else 结构体失败:",n),""}}generateNodeCode(e,t,s,a){let n="";return this.nodeAnalysis.get(e.id)&&(n+=this.generatePreAddedCode(e,t,s,a),e.remark&&e.funcType==="func"&&(n+=`${E.indent(t)}-- ${e.remark.replace(/\n/g," ")}
`),n+=this.generateLogicNodeCode(e,t,s,a)),n}generateFuncCodeWithBranch(e,t,s){let a="";const n=this.funcData.find(l=>l.funcId==e.funcId);if(n){const l=this.convertToLuaVarName(n.className),i=this.generateFunctionArgsWithBranch(e,s);if(this.isGenerateTestLuaScript){const u=`error_${e.id}`,g=i?`, ${i}`:"";a+=`${E.indent(t)}-- 记录抽象函数执行日志，正式脚本会还原为：${this.getNodeVarName(e.id)} = ${l}.${n.funcName}(${i})
`,a+=`${E.indent(t)}${this.getNodeVarName(e.id)}, ${u} = exec.func_and_log(func_step_logs, ${e.id}, ${l}.${n.funcName}${g})
`,a+=`${E.indent(t)}if ${u} then
`,a+=`${E.indent(t+1)}return ${this.getNodeVarName(e.id)}, ${u}
`,a+=`${E.indent(t)}end
`}else a+=`${E.indent(t)}${this.getNodeVarName(e.id)} = ${l}.${n.funcName}(${i})
`}return a}generatePreAddedCode(e,t,s,a){let n="";const l=this.analyzer.getGlobalVarMapPath();if(l.size==0||!l.has(e.id))return n;const i=l.get(e.id);return i&&i.length>0&&i.forEach(u=>{const g=this.analyzer.getNodeById(u);g&&(n+=this.generateNodeCode(g,t,s,a))}),n}getArgParamNameForLogic(e,t){const s=this.nodeAnalysis.get(e),a=this.isMergeNode(e),n=t==null?void 0:t.branchId;return this.getArgParamName(e,a,s,n)}getArgParamName(e,t,s,a){var l;if(t&&s){if(s.isSameSourceMergePoint&&a&&((l=s.branchSourceMap)!=null&&l[a])){const i=Object.values(s.branchSourceMap);i.length>0&&i.includes(e)&&(e=s.branchSourceMap[a])}else if(s.isDifferentSourceMergePoint){for(const[i,u]of Object.entries(s.branchSourceMap))if(u===e){const g=this.analyzer.findRootIfElseBranchIdByNodeId(e);return this.getNodeVarName(g,!0)}}}const n=this.resolveParamSource(e);return this.getNodeVarName(n,!1)}resolveParamSource(e){const t=this.nodeAnalysis.get(e);if(!t||t.type!="condition")return e;let s=e;const a=this.analyzer.getNodeInput(e);return a&&a.forEach(n=>{if(n.source)return s=this.resolveParamSource(n.source),s}),s}resolveParamSourceAll(e){const t=this.nodeAnalysis.get(e);if(!t||t.type!="condition")return[e];const s=[],a=this.analyzer.getNodeInput(e);return a&&a.forEach(n=>{if(n.source){const l=this.resolveParamSourceAll(n.source);s.push(...l)}}),s}generateFunctionArgsWithBranch(e,t){if(e.inputData===void 0||e.inputData===null)return"";const s=this.nodeAnalysis.get(e.id),a=this.isMergeNode(e.id),n=t==null?void 0:t.branchId;return e.inputData.map(i=>i.sourceType==="input"?i.type=="string"?i.source==="$root"||i.source==="$target"||i.source==="$context"?i.source.replace("$",""):i.source=="nil"?"nil":`"${i.source}"`:i.type=="table"&&(i.subType=="number[]"||i.subType=="string[]")&&"length"in i.source?i.subType=="number[]"?`{${i.source.join(",")}}`:`{${i.source.map(u=>`"${u}"`).join(",")}}`:i.type=="function"?`expression_${e.id}_${i.portId}`:i.type=="boolean"?String(i.source)=="true"?"true":"false":i.source:i.sourceType==="node"?this.getArgParamName(i.source,a,s,n):"").filter(i=>i!==void 0&&i!=="").join(", ").trim()}isMergeNode(e){return(this.workflow.edges||[]).filter(s=>s.target===e).length>1}generateLogicNodeCode(e,t,s,a){var l,i,u,g,m,b;let n="";if(((l=e.logicData)==null?void 0:l.logicType)===R.GLOBAL_VARIABLE&&(n=this.globalVariable.generateCode(e,t,this.analyzer)),((i=e.logicData)==null?void 0:i.logicType)===R.CALCULATOR){const G=this.getNodeIncomingEdges(e.id);n=this.calculator.generateCode(e,t,G)}return((u=e.logicData)==null?void 0:u.logicType)===R.GLOBAL_PARAM&&(n=this.globalParam.generateCode(e,t)),((g=e.logicData)==null?void 0:g.logicType)===R.IFELSE&&(n=this.generateIfElseBlock(e,t,s,a)),((m=e.logicData)==null?void 0:m.logicType)===R.TYPE_CONVERTER&&(n=this.typeConverter.generateCode(e,t,a)),((b=e.logicData)==null?void 0:b.logicType)===R.DIMENSION_CONVERTER&&(n=this.dimensionConverter.generateCode(e,t,a)),n}shouldRecordLogicNode(e){return e.funcType==="logic"&&!this.analyzer.isDifferentMerge(e.id)}getMainFlowLastNode(){var e;for(let t=this.executionOrder.length-1;t>=0;t--){const s=this.executionOrder[t],a=this.analyzer.getNodeById(s);if(a&&((e=this.nodeAnalysis.get(s))==null?void 0:e.level)===0)return a}return null}generateReturnStatement(){const e=this.getMainFlowLastNode();if(this.hasDiffMerge){const s=this.analyzer.getMergeDeclarations(),a=[];for(let i=s.length-1;i>=0;i--){const u=s[i];a.push(u)}const n=this.getNodeVarName(e.id,te(e));return`
	return ${a.join(" or ")} or ${n}
`}return te(e)?`
	return tempResult_${e.id}
`:`
	return result_${e.id}
`}convertToLuaVarName(e){return e.replace(/-/g,"_")}generateDifferentSourceMergeBlock(e,t){if(!this.nodeAnalysis.get(e))return"";const a=this.generateGroupedFlagCondition(e),n=1,l=this.analyzer.collectDescendants(e);let i=`
${E.indent(n)}-- 不同源分支汇合点
`;i+=`${E.indent(n)}if ${a} then
`;const u=new Set;i+=this.generateNodeCode(this.analyzer.getNodeById(e),n+1,u),u.add(e);for(const m of l){if(u.has(m))continue;const b=this.analyzer.getNodeById(m);te(b)?i+=this.generateIfElseBlock(b,n+1,u):i+=this.generateNodeCode(b,n+1,u),u.add(m)}const g=this.analyzer.getMergeDeclarations()[t];if(g){const m=l.length>0?l[l.length-1]:e,b=te(this.analyzer.getNodeById(m));i+=`${E.indent(n+1)}${g} = ${this.getNodeVarName(m,b)}
`,this.isGenerateTestLuaScript&&(i+=`${E.indent(n+1)}-- 记录基础函数执行日志，正式脚本不会有下面这行代码
`,i+=`${E.indent(n+1)}exec.logic_and_log(func_step_logs, ${e}, ${g})
`)}return i+=`${E.indent(n)}end
`,i}generateGroupedFlagCondition(e){const t=this.nodeAnalysis.get(e);if(!t||!t.branchSourceMap)return"true";const s=(this.workflow.edges||[]).filter(l=>l.target===e),a=new Map;s.forEach(l=>{const i=l.source,u=Object.keys(t.branchSourceMap).find(g=>t.branchSourceMap[g]===i);if(u){const g=this.analyzer.findRootIfElseBranchIdByNodeId(i);if(g){a.has(g)||a.set(g,[]);const m=this.nodeAnalysis.get(i);m&&m.localBranches?m.localBranches.forEach(b=>{a.get(g).push(`flag_${b}`)}):a.get(g).push(`flag_${u}`)}}});const n=[];return a.forEach((l,i)=>{l.length>0&&n.push(`(${l.join(" or ")})`)}),n.length>0?n.join(" and "):"true"}}const ca=async v=>{const e={};return v.forEach(t=>{te(t)?t.outputData.forEach((s,a,n)=>{a!==n.length-1&&(e[`${t.id}_${s.portId}`]=s.functionCode)}):ta(t)?t.outputData.forEach((s,a,n)=>{e[`${t.id}_${s.portId}`]=s.functionCode}):t.inputData.filter(s=>s.type==="function"||s.widgetType==="function").forEach(s=>{e[`${t.id}_${s.portId}`]=s.source})}),{codeMap:e}},Ve={funcId:"",inputData:[{paramName:"data",type:"table",subType:"any",source:"",sourceType:"node",portId:"in_1"}],outputData:[{paramName:"result",type:"table",subType:"any",portId:"out_1"}]},ua=[{funcId:"1",type:R.GLOBAL_PARAM,title:"全局参数",icon:"G",iconColor:"#722ed1",template:{id:"",funcType:"logic",logicData:{logicType:R.GLOBAL_PARAM},title:"全局参数",remark:"引用全局参数(root/context)，将对应的值直接返回给当前节点",...Ve,inputData:[{paramName:"paramType",type:"any",subType:"any",source:"root",sourceType:"input",portId:"in_1",defaultValue:"root",widgetType:"select",attributes:{paramType:"string",inputType:"text",showLabel:!0,label:"参数类型"},options:[{label:"root(全场景数据)",value:"root",desc:"全场景数据"},{label:"context(指定上下文)",value:"context",desc:"指定上下文"}]}],outputData:[{paramName:"result",type:"any",subType:"any",portId:"out_1"}]}},{funcId:"5",type:R.GLOBAL_VARIABLE,title:"全局变量",icon:"V",iconColor:"#eb2f96",template:{id:"",funcType:"logic",logicData:{logicType:R.GLOBAL_VARIABLE},title:"全局变量",remark:"获取任意节点的结果",...Ve,inputData:[{paramName:"nodeId",type:"string",source:"",sourceType:"input",widgetType:"select",portId:"in_1",defaultValue:"",attributes:{paramType:"string",inputType:"text",showLabel:!0,label:"节点Id"},options:[]}],outputData:[{paramName:"result",type:"any",subType:"any",portId:"out_1"}]}},{funcId:"7",type:R.CALCULATOR,title:"计算器",icon:"C",iconColor:"#faad14",template:{id:"",funcType:"logic",logicData:{logicType:R.CALCULATOR,source:"",condition:""},title:"计算器",remark:`函数名称不受影响，data、data1等为连接当前节点的上游参数
function demo(data, data1, data2) {
    return { data, data1, data2 }
}`,inputData:[{paramName:"data",type:"any",subType:"any",source:"",sourceType:"node",portId:"in_1",defaultValue:"",attributes:{paramType:"any",inputType:"text",showLabel:!0,label:"上游数据"}}],outputData:[{paramName:"result",type:"any",subType:"any",functionCode:`function demo(data, data1, data2) {
    return { data, data1, data2 }
}`,portId:"out_1"}]}},{funcId:"2",type:R.IFELSE,title:"条件函数",icon:"if",iconColor:"#1890ff",template:{id:"",funcType:"logic",logicData:{logicType:R.IFELSE,source:"",condition:""},title:"条件判断",funcId:"",inputData:[{paramName:"data",type:"any",subType:"any",source:"",sourceType:"node",portId:"in_1",defaultValue:"",attributes:{paramType:"any",inputType:"text",showLabel:!0,label:"上游数据"}}],outputData:[{paramName:"result",type:"any",subType:"any",functionCode:"",portId:"out_1"},{paramName:"result",type:"any",subType:"any",functionCode:"",portId:"out_2"}],version:"1.0.0"}},{funcId:"6",type:R.TYPE_CONVERTER,title:"类型转换",icon:"T",iconColor:"#f5222d",template:{id:"",funcType:"logic",logicData:{logicType:R.TYPE_CONVERTER},title:"类型转换",remark:"将上游传递的值强制转换成指定类型",...Ve,inputData:[{paramName:"data",type:"any",subType:"any",source:"",sourceType:"node",portId:"in_1",attributes:{paramType:"any",inputType:"text",showLabel:!0,label:"上游数据"},defaultValue:""},{paramName:"convertType",type:"string",source:"toTable",sourceType:"input",widgetType:"select",portId:"in_2",defaultValue:"toTable",attributes:{paramType:"string",inputType:"text",showLabel:!0,label:"转换方式"},options:[{label:"转成字符串",value:"toString"},{label:"转成数值",value:"toNumber"},{label:"转成table",value:"toTable"},{label:"转成布尔",value:"toBoolean"}]}],outputData:[{paramName:"result",type:"any",subType:"any",portId:"out_1"}]}},{funcId:"9",type:R.DIMENSION_CONVERTER,title:"数据转换",icon:"D",iconColor:"#2f54eb",template:{id:"",funcType:"logic",logicData:{logicType:R.DIMENSION_CONVERTER},title:"数据转换",remark:"对数据进行数据转换操作，支持筛选、提取、转成字符串、转成数值、转成table、转成布尔等操作",...Ve,inputData:[{paramName:"data",type:"any",subType:"any",source:"",sourceType:"node",portId:"in_1",attributes:{paramType:"any",inputType:"text",showLabel:!0,label:"上游数据"},defaultValue:""},{paramName:"option",type:"string",source:"upgrade",sourceType:"input",widgetType:"select",portId:"in_2",defaultValue:"upgrade",attributes:{paramType:"string",inputType:"text",showLabel:!0,label:"转换方式"},options:[{label:"升维",value:"upgrade"},{label:"降维(并使用筛选逻辑)",value:"downgrade_filter"},{label:"降维(并使用提取逻辑)",value:"downgrade_extract"},{label:"转成字符串",value:"toString"},{label:"转成数值",value:"toNumber"},{label:"转成布尔",value:"toBoolean"}]},{paramName:"expression",type:"function",subType:"any",source:"",sourceType:"input",widgetType:"function",portId:"in_3",attributes:{paramType:"function",inputType:"text",showLabel:!0,label:"表达式"},defaultValue:""}]}}],ft=Wt({id:"base-function",state:()=>({baseFunctionNode:[],baseFunctionNodeMap:new Map}),getters:{},actions:{getFuncNode(){return this.baseFunctionNode.length===0&&(this.baseFunctionNode=ua,this.baseFunctionNode.forEach(v=>{this.baseFunctionNodeMap.set(v.funcId,v)})),this.baseFunctionNode},serBaseFuncNodeShow(v,e){const t=this.baseFunctionNodeMap.get(v);this.baseFunctionNodeMap.set(v,{...t,show:e})},getFuncNodeMap(){return this.baseFunctionNodeMap}}}),da=["width","height"],fa=["fill"],pa={x:"16",y:"21","text-anchor":"middle","font-size":"14",fill:"#fff"},ha=pt({__name:"BaseNodeIcon",props:{type:{},logicType:{},size:{default:24}},setup(v){const e=v,t=I(),s=I();return Kt(()=>{var a,n;t.value=((a=ft().getFuncNode().find(l=>l.type===e.type))==null?void 0:a.iconColor)||"#faad14",s.value=((n=ft().getFuncNode().find(l=>l.type===e.type))==null?void 0:n.icon)||"Fn"}),(a,n)=>(L(),z("svg",{width:v.size,height:v.size,viewBox:"0 0 32 32"},[h("rect",{x:"6",y:"6",width:"20",height:"20",rx:"6",fill:t.value},null,8,fa),h("text",pa,q(s.value),1)],8,da))}});const ga=ht(ha,[["__scopeId","data-v-6c387363"]]);function ma(v){return ae.post({url:"/cloudstorage/form-sign",data:v})}function Os(v){return ae.post({url:"/rule-config/execution-record/page",data:v})}function va(v){return ae.post({url:"/rule-config/execution-record/add",data:v})}function ya(v){return ae.post({url:"/rule-config/rule/debug",data:v})}function Bs(v){return ae.post({url:"/umas/common/dict/get",data:v})}function _a(){return ae.post({url:"/rule-config/rule/getAllRule"})}function Na(v){return ae.post({url:"/rule-config/rule/getSimpleRuleById",data:{id:v}})}function Rs(v){return ae.post({url:"/rule-config/execution-record/delete",data:v})}function ba(v){return ae.post({url:"/rule-config/execution-record/get-test-case",data:v})}function $a(v){return ae.post({url:"/rule-config/execution-record/delete",data:v})}function wa(v){return ae.post({url:"/rule-config/execution-record/save-expected-result",data:v})}const Ta={key:0,class:"fullscreen-editor-overlay"},Ma={class:"fullscreen-editor-container"},Ea={class:"editor-toolbar"},Ia={key:1,class:"fullscreen-editor-overlay"},Sa={class:"fullscreen-editor-container"},Ca={class:"editor-toolbar"},La={key:2,class:"fullscreen-editor-overlay"},ka={class:"fullscreen-editor-container"},xa={class:"editor-toolbar"},Pa={class:"drawer-header"},Da={class:"drawer-title-container"},Va={class:"drawer-title"},Oa={class:"drawer-actions"},Ba={class:"drawer-content"},Ra={class:"tab-content"},Aa={class:"xml-header"},za={class:"upload-section"},Fa={class:"test-case-section"},ja=["onClick"],Ga={class:"test-case-info"},Xa={key:0,class:"test-case-name-with-part"},Ja=["title"],Ua=["title"],Wa=["title"],Ka={class:"test-case-actions"},qa=["onClick"],Ha={key:0,class:"no-test-cases"},Ya={class:"editor-container"},Qa={class:"editor-toolbar"},Za={class:"tab-content"},es={class:"script-header"},ts={class:"editor-container"},as={class:"editor-toolbar"},ss={class:"tab-content"},os={key:0,class:"result-container"},ns={class:"result-header"},rs={class:"result-baseInfo"},ls={class:"result-status-text"},is={key:0,class:"result-time"},cs={key:0,class:"result-message"},us={class:"result-message-content"},ds={key:1,class:"result-success-output"},fs={class:"output-actions"},ps={key:2,class:"result-expected-output"},hs={class:"output-actions"},gs={class:"node-item"},ms={class:"node-icon"},vs={class:"node-content"},ys={class:"node-header"},_s={class:"node-main-info"},Ns={class:"node-name"},bs={class:"node-duration"},$s={class:"node-detail-content"},ws={class:"editor-section"},Ts={class:"editor-container fixed-height"},Ms={class:"editor-toolbar"},Es={class:"editor-section"},Is={class:"editor-container fixed-height"},Ss={class:"editor-toolbar"},Cs={key:1,class:"no-content-tip"},oe="vs",ne="vs",Ls=pt({__name:"index",emits:["close","node-click"],setup(v,{expose:e,emit:t}){const s=t,a=I(!1),n=I("xml"),l=I(null),i=I(""),u=I(""),g=I(""),m=I(""),b=I(""),G=I(!1),$=I(!1),se=I(!1),M=I({duration:0,funcStepLogs:[],message:"",success:!1}),ue=I(null),B=I(!1),Oe=I(!1),ce=I(!1),re=I(!1),Ye=new ia,pe=I(new Map),le=I([]),U=I(null),Qe=I(!1),we=I(null),gt=I(null),Te=I([]),F=lt(()=>{if(!M.value.funcStepLogs||M.value.funcStepLogs.length===0)return null;const o=M.value.funcStepLogs[M.value.funcStepLogs.length-1];return Object.prototype.hasOwnProperty.call(o,"result")?JSON.stringify(o.result,null,2):null}),Me=lt(()=>{var o;return((o=U.value)==null?void 0:o.expectedResult)||""}),Be=I(!1),X=I({xml:!1,script:!1}),C=I(null),ve=I(null),_e=I(null),Ee=I(null),Re=I(null),Ae=I(null),ze=I(null),Fe=I(null),je=I(null);let x=null,A=null,H=null,W=null,D=null,V=null,j=null;const Ne=I([]),mt=async o=>{if(!o)return"";const r=JSON.parse(o),c=r.nodeList.filter(y=>y.funcType==="func").map(y=>y.funcId);if(c.length===0)return Ye.generate(r,[],{});const d=(await Zt(c)).map(y=>ea(y)),{codeMap:N}=await ca(r.nodeList);if(N)return Ye.generate(r,d,N)},vt=async()=>{try{const o=await _a();o.success&&(Ne.value=o.data.filter(r=>r.hasLuaScript).map(r=>({id:r.id,ruleName:r.ruleName,hasLuaScript:r.hasLuaScript})))}catch(o){console.error("获取规则数据失败:",o)}},Ge=async o=>{if(o)try{Qe.value=!0;const r=await ba({ruleId:o});r&&r.data&&r.data.length>0?(Te.value=r.data,le.value=r.data):(le.value=[],Te.value=[])}catch(r){console.error("获取用例列表失败:",r),le.value=[],Te.value=[]}finally{Qe.value=!1}},yt=async o=>{U.value=o,i.value=o.partId,m.value=o.ossPath,b.value=o.fileCName,await ot()},_t=async o=>{var r;try{await Qt.confirm(`确定要删除用例 "${o.fileCName}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),we.value=o.id;const c=le.value.findIndex(d=>d.id===o.id);c>-1&&le.value.splice(c,1),((r=U.value)==null?void 0:r.id)===o.id&&(U.value=null,i.value="",u.value="",m.value="",b.value="",x&&x.setValue(""));const f={id:o.id};$a(f).then(()=>{T.success("用例删除成功")}).catch(()=>{T.error("删除用例失败")})}catch(c){c!=="cancel"&&(console.error("删除用例失败:",c),T.error("删除用例失败"))}finally{we.value=null}};ye(l,async o=>{if(o&&Ne.value.length>0){try{const r=await Na(o);if(r.success&&r.data){const c=r.data;if(c.configData){const f=JSON.parse(c.configData);pe.value=new Map,f.nodeList.forEach(N=>{pe.value.set(N.id,N)});const d=await mt(c.configData);g.value=d,A&&A.setValue(d)}}}catch(r){console.error("获取规则详情失败:",r)}await Ge(o)}});const Ze=()=>{if(x){const o=x.getValue();navigator.clipboard.writeText(o).then(()=>{T.success("XML内容已复制到剪贴板")}).catch(()=>{T.error("复制失败，请手动选择复制")})}},et=()=>{if(A){const o=A.getValue();navigator.clipboard.writeText(o).then(()=>{T.success("脚本内容已复制到剪贴板")}).catch(()=>{T.error("复制失败，请手动选择复制")})}},Xe=(o,r)=>{let c="";if(o==="last"){if(!F.value){T.warning("没有可复制的内容");return}c=F.value}else{const f=parseInt(o),d=M.value.funcStepLogs[f];if(!d)return;c=JSON.stringify(r==="input"?d.inputParams||{}:d.result||{},null,2)}navigator.clipboard.writeText(c).then(()=>{o==="last"?T.success("最后一个节点输出已复制到剪贴板"):T.success(`${r==="input"?"请求参数":"响应结果"}已复制到剪贴板`)}).catch(()=>{T.error("复制失败，请手动选择复制")})},Nt=async()=>{var o;if(!F.value){T.warning("没有可保存的输出结果");return}if(!l.value){T.warning("请先选择工作流规则");return}if(!U.value){T.warning("请先选择测试用例");return}if(!m.value){T.warning("没有XML文件信息");return}try{const r={id:((o=U.value)==null?void 0:o.id)||0,expectedResult:F.value},c=await wa(r);c.success?(T.success("预期结果保存成功"),U.value&&(U.value.expectedResult=F.value),W&&W.setValue(F.value)):T.error(c.error||"保存预期结果失败")}catch(r){console.error("保存预期结果失败:",r),T.error("保存预期结果失败")}},tt=async()=>{let o="",r="";if(x?o=x.getValue():u.value&&(o=u.value),!o.trim()){T.warning("没有可下载的XML内容");return}try{b.value?r=b.value:r=`xml_content_${new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5)}.xml`;const c=new Blob([o],{type:"application/xml;charset=utf-8"}),f=window.URL.createObjectURL(c),d=document.createElement("a");d.href=f,d.download=r,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(f),T.success(`XML文件下载成功: ${r}`)}catch(c){console.error("下载XML文件失败:",c),T.error("下载XML文件失败")}},at=()=>{if(A){const o=A.getValue();if(!o.trim()){T.warning("脚本内容为空");return}let r="unknown";if(l.value&&Ne.value.length>0){const y=Ne.value.find(P=>P.id===l.value);y&&y.ruleName&&(r=y.ruleName.replace(/[<>:"/\\|?*]/g,"_").trim())}const c=new Blob([o],{type:"text/plain;charset=utf-8"}),f=window.URL.createObjectURL(c),d=document.createElement("a");d.href=f;const N=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);d.download=`${r}_${N}.lua`,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(f),T.success("脚本文件下载成功")}else T.warning("没有可下载的脚本内容")},Je=(o,r)=>{let c="",f="";if(o&&r)if(o==="last"){if(!F.value){T.warning("没有可下载的输出内容");return}c=F.value,f="last_node_output"}else{const d=parseInt(o);if(d<0||d>=M.value.funcStepLogs.length){T.warning(`节点索引超出范围: ${d}`);return}const N=M.value.funcStepLogs[d];if(!N){T.warning("节点数据不存在");return}c=JSON.stringify(r==="input"?N.inputParams||{}:N.result||{},null,2),f=`${String(N.title||N.nodeId||"node").replace(/[<>:"/\\|?*]/g,"_").trim()}_${r}_${d}`}else if(C.value)if(C.value.nodeId==="last"){if(!F.value){T.warning("没有可下载的输出内容");return}c=F.value,f="last_node_output"}else{const d=parseInt(C.value.nodeId);if(d<0||d>=M.value.funcStepLogs.length){T.warning(`节点索引超出范围: ${d}`);return}const N=M.value.funcStepLogs[d];if(!N){T.warning("节点数据不存在");return}c=C.value.type==="input"?JSON.stringify(N.inputParams||{},null,2):JSON.stringify(N.result||{},null,2),f=`${String(N.title||N.nodeId||"node").replace(/[<>:"/\\|?*]/g,"_").trim()}_${C.value.type}_${d}`}else{T.warning("没有可下载的JSON内容");return}if(!c.trim()){T.warning("JSON内容为空");return}try{const d=new Blob([c],{type:"application/json;charset=utf-8"}),N=window.URL.createObjectURL(d),y=document.createElement("a");y.href=N;const P=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);y.download=`${f}_${P}.json`,document.body.appendChild(y),y.click(),document.body.removeChild(y),window.URL.revokeObjectURL(N),T.success("JSON文件下载成功")}catch(d){console.error("下载JSON文件时出错:",d),T.error("下载JSON文件失败")}},st=o=>{if(!o.trim())return o;try{const c=new DOMParser().parseFromString(o,"application/xml"),f=c.querySelector("parsererror");if(f)return console.warn("XML解析失败，返回原始内容:",f.textContent),o;const N=new XMLSerializer().serializeToString(c);return bt(N)}catch(r){return console.warn("XML格式化失败，返回原始内容:",r),o}},bt=o=>{const c=o.replace(/></g,`>
<`).replace(/^\s+|\s+$/g,"").split(`
`);let f=0;const d="  ";return c.map(N=>{const y=N.trim();if(!y)return"";y.startsWith("</")&&(f=Math.max(0,f-1));const P=d.repeat(f)+y;return y.startsWith("<")&&!y.startsWith("</")&&!y.endsWith("/>")&&f++,P}).join(`
`)},$t=(o,r)=>{if(!r||!o)return"";try{const f=new DOMParser().parseFromString(o,"application/xml"),d=f.querySelector("parsererror");if(d)return console.warn("XML解析失败:",d.textContent),"";const N=f.querySelector(`[id="${r}"]`);return N&&N.getAttribute("name")||""}catch(c){return console.warn("根据partID查找节点name失败:",c),""}},ot=async()=>{if(m.value)try{const o=await ae.post({url:"/cloudstorage/sign",data:{signType:1,key:m.value}});if(!o.success)throw new Error("获取文件链接失败");const r=o.data,c=await fetch(r);if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const f=await c.text(),d=st(f);u.value=d,x?(x.setValue(d),x.updateOptions({readOnly:B.value})):setTimeout(()=>{x&&(x.setValue(d),x.updateOptions({readOnly:B.value}))},800)}catch(o){console.error("获取XML内容失败:",o),T.error("获取XML文件内容失败")}},be=o=>{X.value[o]=!X.value[o],X.value[o]?(document.body.style.overflow="hidden",Object.keys(X.value).forEach(r=>{r!==o&&(X.value[r]=!1)}),monaco.editor.setTheme(oe),setTimeout(()=>{o==="xml"?wt():o==="script"&&Tt()},100)):(document.body.style.overflow="",o==="xml"&&D?(D.dispose(),D=null):o==="script"&&V&&(V.dispose(),V=null))},wt=()=>{D||!ze.value||(D=monaco.editor.create(ze.value,{value:u.value,language:"xml",theme:oe,readOnly:B.value,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,lineNumbers:"on",folding:!0,wordWrap:"on"}),D.onDidChangeModelContent(()=>{u.value=(D==null?void 0:D.getValue())||""}),setTimeout(()=>{D==null||D.layout(),D==null||D.focus()},100))},Tt=()=>{V||!Fe.value||(V=monaco.editor.create(Fe.value,{value:g.value,language:"typescript",theme:oe,readOnly:B.value,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,lineNumbers:"on",folding:!0}),V.onDidChangeModelContent(()=>{g.value=(V==null?void 0:V.getValue())||""}),setTimeout(()=>{V==null||V.layout(),V==null||V.focus()},100))},Ie=(o,r)=>{if(o==="last"){if(!F.value)return}else if(!he.has(o))return;if(C.value){const c=C.value.nodeId,f=C.value.type;if(C.value=null,document.body.style.overflow="",j&&(j.dispose(),j=null),o===c&&r===f)return}C.value={nodeId:o,type:r},document.body.style.overflow="hidden",setTimeout(()=>{Mt(o,r)},100)},Mt=(o,r)=>{if(j||!je.value)return;let c="";if(o==="last")c=F.value||"";else{const f=parseInt(o),d=M.value.funcStepLogs[f];if(!d)return;c=JSON.stringify(r==="input"?d.inputParams??null:d.result??null,null,2)}j=monaco.editor.create(je.value,{value:c,language:"json",theme:ne,readOnly:!0,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,lineNumbers:"on",folding:!0,wordWrap:"on"}),setTimeout(()=>{j==null||j.layout(),j==null||j.focus()},100)},Se=o=>{if(o.key==="Escape"){const r=Object.keys(X.value).find(c=>X.value[c]);r?(be(r),o.preventDefault(),o.stopPropagation()):C.value&&(Ie(C.value.nodeId,C.value.type),o.preventDefault(),o.stopPropagation())}},Et=async()=>{l.value&&await Ge(l.value)},Ue=()=>{x||!ve.value||(monaco.editor.setTheme(oe),x=monaco.editor.create(ve.value,{value:u.value,language:"xml",theme:oe,readOnly:B.value,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,lineNumbers:"on",folding:!0}),x.onDidChangeModelContent(()=>{u.value=(x==null?void 0:x.getValue())||""}))},nt=()=>{A||!_e.value||(monaco.editor.setTheme(oe),A=monaco.editor.create(_e.value,{value:g.value,language:"lua",theme:oe,readOnly:B.value,minimap:{enabled:!0},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,lineNumbers:"on",folding:!0}),A.onDidChangeModelContent(()=>{g.value=(A==null?void 0:A.getValue())||""}))},It=async o=>{const r=c=>new Promise((f,d)=>{const N=new FileReader;N.onload=y=>f(y.target.result),N.onerror=()=>d(new Error("读取文件失败")),N.readAsText(c)});if(!o||!o.raw){T.error("文件上传失败");return}G.value=!0;try{const c=await r(o.raw),f=st(c),d=await St(o.raw),N=await Ct(o.raw,d);if(m.value=N.ossPath,b.value=o.raw.name,u.value=f,x?(x.setValue(f),x.updateOptions({readOnly:B.value})):setTimeout(()=>{ve.value&&(Ue(),x.setValue(f),x.updateOptions({readOnly:B.value}))},800),l.value){const y={id:Date.now(),ruleId:l.value,partId:"",executionResult:"",executionTime:0,remark:"",ossPath:N.ossPath,fileCName:o.raw.name,status:1,createTime:1,modifyTime:1,creator:"",creatorName:"",modifier:"",modifierName:"",ruleName:"",ruleDesc:"",ruleStatus:"",sceneCategory:"",ruleType:"",luaScript:"",configData:"",expectedResult:"",partName:""};le.value.unshift(y),U.value=y,i.value=y.partId,T.success("XML文件上传成功")}else T.success("XML文件上传成功")}catch(c){console.error("文件上传失败:",c)}finally{G.value=!1}},St=async o=>{const f={signType:1,protocolType:0,key:`data/rule/test/${Date.now()}/xml/${o.name}`},d=await ma(f);if(!d.success)throw new Error(d.error||"获取文件签名失败");return d.data},Ct=async(o,r)=>new Promise((c,f)=>{const d=new FormData;d.append("OSSAccessKeyId",r.signParams.OSSAccessKeyId),d.append("policy",r.signParams.policy),d.append("signature",r.signParams.signature),d.append("success_action_status",r.signParams.success_action_status),d.append("x-oss-meta-auth",r.signParams["x-oss-meta-auth"]),d.append("key",r.key),d.append(r.formFile,o);const N=new XMLHttpRequest;N.upload.onprogress=y=>{y.lengthComputable&&Math.round(y.loaded/y.total*100)},N.onload=()=>{N.status===200?c({ossPath:`${r.key}`}):f(new Error(`上传失败，状态码: ${N.status}`))},N.onerror=()=>{f(new Error("网络错误，上传失败"))},N.open("POST",r.url),N.send(d)}),Lt=async()=>{var o,r;if(!m.value){T.warning("请先上传XML文件");return}if(!g.value){T.warning("请输入脚本内容");return}$.value=!0;try{const c={ruleId:l.value,ossPath:m.value,partId:((o=i.value)==null?void 0:o.trim())||""},f=Te.value.some(y=>y.ruleId===c.ruleId&&y.ossPath===c.ossPath&&(y.partId||"")===c.partId),d={ossPath:m.value,productId:(r=i.value)==null?void 0:r.trim(),returnPartAttributes:["id","name"],luaScript:g.value},N=await ya(d);if(N.success){const y=JSON.parse(N.data.result);y.funcStepLogs=((y==null?void 0:y.funcStepLogs)||[]).map(P=>{const J=pe.value.get(P.nodeId.toString());return J&&(P={...P,logicData:J.logicData,title:J.title,funcType:J.funcType,funcId:J.funcId,remark:J.remark,pos:J.pos}),P}),M.value=y,await Dt(),n.value="result",y.success||setTimeout(()=>{xt()},100)}}catch(c){console.error("测试执行失败:",c)}finally{$.value=!1}},kt=(o,r=!1,c=!1,f,d=!1)=>{var N;if(a.value=!0,Be.value=d,B.value=r,Oe.value=c,o||(i.value="",u.value="",g.value="",m.value="",b.value="",M.value={duration:0,funcStepLogs:[],message:"",success:!1},pe.value.clear(),ue.value=null,ce.value=!1,re.value=!1,l.value=null,le.value=[],U.value=null,Ke(),Object.keys(X.value).forEach(y=>{X.value[y]=!1}),C.value=null),Oe.value&&o.ruleId&&(l.value=o.ruleId),o!=null&&o.partId&&(i.value=(N=o==null?void 0:o.partId)==null?void 0:N.trim()),o!=null&&o.ossPath&&(m.value=o.ossPath,ot()),o!=null&&o.fileCName&&(b.value=o==null?void 0:o.fileCName),o!=null&&o.luaScript&&(g.value=o.luaScript,A&&(A.setValue(o.luaScript),A.updateOptions({readOnly:B.value})),l.value=o.ruleId),o!=null&&o.configData){const y=JSON.parse(o.configData);pe.value=new Map,y.nodeList.forEach(P=>{pe.value.set(P.id,P)})}if(o!=null&&o.executionResult){const y=typeof o.executionResult=="string"?JSON.parse(o.executionResult):o.executionResult;y.funcStepLogs=y.funcStepLogs.map(P=>{const J=pe.value.get(P.nodeId.toString());return J&&(P={...P,logicData:J.logicData,title:J.title,funcType:J.funcType,funcId:J.funcId,remark:J.remark,pos:J.pos}),P}),M.value=y}f?n.value=f:B.value&&(n.value="xml"),vt(),setTimeout(()=>{n.value==="xml"||n.value==="script"?monaco.editor.setTheme(oe):n.value==="result"&&monaco.editor.setTheme(ne)},300)},xt=()=>{Ee.value&&(Ee.value.scrollTop=Ee.value.scrollHeight)},Pt=()=>{We()},We=()=>{Object.keys(X.value).forEach(o=>{X.value[o]=!1}),C.value&&(C.value=null),D&&(D.dispose(),D=null),V&&(V.dispose(),V=null),j&&(j.dispose(),j=null),$e(),M.value={duration:0,funcStepLogs:[],message:"",success:!1},ue.value=null,ce.value=!1,re.value=!1,document.body.style.overflow="",a.value=!1,s("close")},Dt=async()=>{var o;if(!m.value){T.warning("请先上传XML文件");return}if(!l.value){T.warning("请先选择工作流规则");return}if(!M.value.message){T.warning("请先执行脚本");return}se.value=!0;try{const r=(o=i.value)==null?void 0:o.trim();let c="";r&&(c=$t(u.value,r));const f={ruleId:Number(l.value),partId:r,partName:c,luaScript:g.value,executionResult:JSON.stringify(M.value),executionTime:M.value.duration||0,remark:"自动保存",ossPath:m.value,fileCName:b.value||""},d=await va(f);if(d.success&&(T.success("测试结果保存成功"),U.value&&U.value.id>1e12)){const N=U.value;N.id=d.data,await Ge(l.value);const y=le.value.find(P=>P.id===d.data);y&&(U.value=y)}}catch(r){console.error("保存测试结果失败:",r)}finally{se.value=!1}};ye(a,o=>{o?(document.addEventListener("keydown",Se),n.value==="xml"||n.value==="script"?monaco.editor.setTheme(oe):n.value==="result"&&monaco.editor.setTheme(ne),setTimeout(()=>{n.value==="xml"&&ve.value?(Ue(),Et()):n.value==="script"&&_e.value&&nt()},300)):(document.removeEventListener("keydown",Se),Object.keys(X.value).forEach(r=>{X.value[r]=!1}),C.value&&(C.value=null),D&&(D.dispose(),D=null),V&&(V.dispose(),V=null),j&&(j.dispose(),j=null),$e(),ke(),document.body.style.overflow="",Ke())});const Ke=()=>{x&&(x.dispose(),x=null),A&&(A.dispose(),A=null),$e(),ke(),D&&(D.dispose(),D=null),V&&(V.dispose(),V=null),j&&(j.dispose(),j=null),he.forEach(o=>{var r,c;(r=o.input)==null||r.dispose(),(c=o.output)==null||c.dispose()}),he.clear()},Vt=o=>{const r=M.value.funcStepLogs[parseInt(o)];r&&s("node-click",r)},Ot=()=>{ce.value=!ce.value,ce.value?setTimeout(()=>{F.value&&Ce()},100):$e()},Bt=()=>{re.value=!re.value,re.value?setTimeout(()=>{Me.value&&Le()},100):ke()},Ce=()=>{!Re.value||!F.value||(H&&$e(),monaco.editor.setTheme(ne),H=monaco.editor.create(Re.value,{value:F.value,language:"json",theme:ne,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,folding:!0,scrollbar:{vertical:"visible",horizontal:"visible",verticalScrollbarSize:12,horizontalScrollbarSize:12},overviewRulerBorder:!1,hideCursorInOverviewRuler:!0,overviewRulerLanes:0}),setTimeout(()=>{H==null||H.layout(),H==null||H.setScrollPosition({scrollTop:0,scrollLeft:0}),ce.value=!0},100))},$e=()=>{H&&(H.dispose(),H=null)},Le=()=>{Ae.value&&(W&&ke(),monaco.editor.setTheme(ne),W=monaco.editor.create(Ae.value,{value:Me.value||"",language:"json",theme:ne,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,folding:!0,scrollbar:{vertical:"visible",horizontal:"visible",verticalScrollbarSize:12,horizontalScrollbarSize:12},overviewRulerBorder:!1,hideCursorInOverviewRuler:!0,overviewRulerLanes:0}),setTimeout(()=>{W==null||W.layout(),W==null||W.setScrollPosition({scrollTop:0,scrollLeft:0}),re.value=!0},100))},ke=()=>{W&&(W.dispose(),W=null)},he=new Map,rt=(o,r,c)=>{var N,y;if(!o)return;he.has(r)||he.set(r,{input:null,output:null});const f=he.get(r);if(f[c])return;monaco.editor.setTheme(ne);const d=monaco.editor.create(o,{value:JSON.stringify(c==="input"?((N=M.value.funcStepLogs[parseInt(r)])==null?void 0:N.inputParams)??null:((y=M.value.funcStepLogs[parseInt(r)])==null?void 0:y.result)??null,null,2),language:"json",theme:ne,readOnly:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:12,folding:!0,scrollbar:{vertical:"visible",horizontal:"visible",verticalScrollbarSize:12,horizontalScrollbarSize:12},overviewRulerBorder:!1,hideCursorInOverviewRuler:!0,overviewRulerLanes:0});f[c]=d,setTimeout(()=>{d.layout(),d.setScrollPosition({scrollTop:0,scrollLeft:0})},100),C.value&&C.value.nodeId===r&&C.value.type===c&&setTimeout(()=>{d.layout()},200)};ye(n,async o=>{setTimeout(async()=>{o==="xml"?(monaco.editor.setTheme(oe),!x&&ve.value?Ue():x&&x.layout()):o==="script"?(monaco.editor.setTheme(oe),!A&&_e.value?nt():A&&A.layout()):o==="result"&&(monaco.editor.setTheme(ne),M.value.message&&setTimeout(()=>{ce.value=!0,Ce(),re.value=!0,Le()},500))},100)}),ye(ue,()=>{setTimeout(()=>{monaco.editor.setTheme(ne),he.forEach((o,r)=>{var d,N;const c=parseInt(r),f=M.value.funcStepLogs[c];f&&(o.input&&o.input.setValue(JSON.stringify(f.inputParams??null,null,2)),o.output&&o.output.setValue(JSON.stringify(f.result??null,null,2))),(d=o.input)==null||d.layout(),(N=o.output)==null||N.layout()})},300)}),ye(()=>M.value.success,o=>{o&&F.value&&setTimeout(()=>{Ce(),re.value=!0,Le(),Rt()},100)}),ye(()=>M.value,o=>{n.value==="result"&&M.value.success&&setTimeout(()=>{H&&F.value?H.setValue(F.value):F.value&&Ce(),W?W.setValue(Me.value||""):Me.value&&Le()},50)},{deep:!0});const Rt=()=>{setTimeout(()=>{const o=document.querySelector(".result-success-output");o&&o.scrollIntoView({behavior:"smooth",block:"center"})},600)};return qt(()=>{document.addEventListener("keydown",Se)}),Ht(()=>{document.removeEventListener("keydown",Se),Ke()}),e({openDrawer:kt,closeDrawer:We,showMask:Be}),(o,r)=>{const c=Y("el-icon"),f=Y("el-button"),d=Y("el-input"),N=Y("el-upload"),y=Y("el-empty"),P=Y("el-tab-pane"),J=Y("el-option"),At=Y("el-select"),zt=Y("el-tooltip"),Ft=Y("el-space"),jt=Y("el-collapse-item"),Gt=Y("el-collapse"),Xt=Y("el-tabs");return L(),z(Pe,null,[(L(),Q(Yt,{to:"body"},[X.value.xml?(L(),z("div",Ta,[h("div",Ma,[h("div",Ea,[p(f,{type:"primary",size:"small",circle:"",onClick:O(tt,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:O(Ze,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[0]||(r[0]=O(w=>be("xml"),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ie))]),_:1})]),_:1})]),h("div",{ref_key:"xmlEditorFullscreenContainer",ref:ze,class:"monaco-editor-container"},null,512)])])):Z("",!0),X.value.script?(L(),z("div",Ia,[h("div",Sa,[h("div",Ca,[p(f,{type:"primary",size:"small",circle:"",onClick:O(at,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:O(et,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[1]||(r[1]=O(w=>be("script"),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ie))]),_:1})]),_:1})]),h("div",{ref_key:"scriptEditorFullscreenContainer",ref:Fe,class:"monaco-editor-container"},null,512)])])):Z("",!0),C.value?(L(),z("div",La,[h("div",ka,[h("div",xa,[p(f,{type:"primary",size:"small",circle:"",onClick:r[2]||(r[2]=O(w=>Je(C.value.nodeId,C.value.type),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[3]||(r[3]=O(w=>Xe(C.value.nodeId,C.value.type),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[4]||(r[4]=O(w=>Ie(C.value.nodeId,C.value.type),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ie))]),_:1})]),_:1})]),h("div",{ref_key:"nodeEditorFullscreenContainer",ref:je,class:"monaco-editor-container"},null,512)])])):Z("",!0)])),a.value&&Be.value?(L(),z("div",{key:0,class:"drawer-mask",onClick:Pt})):Z("",!0),h("div",{class:de(["test-drawer",{"drawer-open":a.value}])},[h("div",Pa,[h("div",Da,[h("div",Va,q(B.value?"测试详情":"测试"),1)]),h("div",Oa,[p(f,{size:"small",circle:"",onClick:We,class:"close-btn"},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ie))]),_:1})]),_:1})])]),h("div",Ba,[p(Xt,{modelValue:n.value,"onUpdate:modelValue":r[10]||(r[10]=w=>n.value=w),class:"test-tabs",stretch:!0},{default:_(()=>[p(P,{label:"XML检测",name:"xml"},{default:_(()=>[h("div",Ra,[h("div",Aa,[p(d,{modelValue:i.value,"onUpdate:modelValue":r[5]||(r[5]=w=>i.value=w),placeholder:"part节点ID",class:"part-id-input",disabled:B.value,style:{width:"150px"},clearable:""},null,8,["modelValue","disabled"]),h("div",za,[B.value?Z("",!0):(L(),Q(N,{key:0,"auto-upload":!1,"show-file-list":!1,accept:".xml",onChange:It},{default:_(()=>[p(f,{type:"primary",loading:G.value},{default:_(()=>[qe(q(G.value?"上传中...":"导入XML"),1)]),_:1},8,["loading"])]),_:1}))])]),h("div",Fa,[h("div",{class:"test-case-list",ref_key:"testCaseListRef",ref:gt},[(L(!0),z(Pe,null,He(le.value,w=>{var K;return L(),z("div",{key:w.id,class:de(["test-case-item",{active:((K=U.value)==null?void 0:K.id)===w.id}]),onClick:xe=>yt(w)},[h("div",Ga,[w.partName&&w.partName.length>0?(L(),z("div",Xa,[h("div",{class:"test-case-name",title:w.fileCName},q(w.fileCName),9,Ja),h("div",{class:"test-case-part-name",title:w.partName},q(w.partName),9,Ua)])):(L(),z("div",{key:1,class:"test-case-name-full",title:w.fileCName},q(w.fileCName),9,Wa))]),h("div",Ka,[B.value?Z("",!0):(L(),z("span",{key:0,class:de(["delete-text-btn",{loading:we.value===w.id}]),onClick:O(xe=>_t(w),["stop"])},q(we.value===w.id?"删除中...":"删除"),11,qa))])],10,ja)}),128)),le.value.length===0?(L(),z("div",Ha,[p(y,{description:"暂无用例数据","image-size":10})])):Z("",!0)],512)]),h("div",Ya,[h("div",Qa,[p(f,{type:"primary",size:"small",circle:"",onClick:O(tt,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:O(Ze,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[6]||(r[6]=O(w=>be("xml"),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[(L(),Q(fe(X.value.xml?S(ie):S(De))))]),_:1})]),_:1})]),h("div",{ref_key:"xmlEditorContainer",ref:ve,class:"monaco-editor-container"},null,512)])])]),_:1}),p(P,{label:"脚本展示",name:"script"},{default:_(()=>[h("div",Za,[h("div",es,[p(At,{modelValue:l.value,"onUpdate:modelValue":r[7]||(r[7]=w=>l.value=w),placeholder:"请选择工作流规则",class:"rule-select",disabled:B.value||Oe.value,clearable:"",filterable:""},{default:_(()=>[(L(!0),z(Pe,null,He(Ne.value,w=>(L(),Q(J,{key:w.id,label:`${w.id}: ${w.ruleName}`,value:w.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),B.value?Z("",!0):(L(),Q(f,{key:0,type:"primary",loading:$.value,onClick:O(Lt,["stop"])},{default:_(()=>[qe(q($.value?"执行中...":"执行测试"),1)]),_:1},8,["loading"]))]),h("div",ts,[h("div",as,[p(f,{type:"primary",size:"small",circle:"",onClick:O(at,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:O(et,["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1}),p(f,{type:"primary",size:"small",circle:"",onClick:r[8]||(r[8]=O(w=>be("script"),["stop"]))},{default:_(()=>[p(c,null,{default:_(()=>[(L(),Q(fe(X.value.script?S(ie):S(De))))]),_:1})]),_:1})]),h("div",{ref_key:"scriptEditorContainer",ref:_e,class:"monaco-editor-container"},null,512)])])]),_:1}),p(P,{label:"执行结果",name:"result",lazy:""},{default:_(()=>[h("div",ss,[M.value.message?(L(),z("div",os,[h("div",ns,[h("div",rs,[h("div",{class:de(["result-status",{success:M.value.success}])},[h("span",{class:de(["result-status-icon",{success:M.value.success}])},[p(c,null,{default:_(()=>[(L(),Q(fe(M.value.success?S(it):S(ie))))]),_:1})],2),h("span",ls,q(M.value.success?"成功":"失败"),1)],2),M.value.duration?(L(),z("div",is," 规则执行时长："+q(S(dt)(M.value.duration)),1)):Z("",!0)]),M.value.success?Z("",!0):(L(),z("div",cs,[r[11]||(r[11]=h("div",{class:"result-message-title"},"执行失败原因",-1)),h("div",us,q(M.value.message||"暂无执行结果"),1)])),M.value.success&&F.value?(L(),z("div",ds,[h("div",{class:"output-header",onClick:Ot},[r[13]||(r[13]=h("div",{class:"output-title"},[h("span",null,"输出结果")],-1)),h("div",fs,[p(f,{type:"primary",size:"small",onClick:O(Nt,["stop"])},{default:_(()=>[...r[12]||(r[12]=[qe(" 保存为预期结果 ",-1)])]),_:1}),p(c,{class:"output-icon"},{default:_(()=>[(L(),Q(fe(ce.value?S(ct):S(ut))))]),_:1})])]),h("div",{class:de(["output-content",{expanded:ce.value}])},[h("div",{ref_key:"lastNodeOutputEditorContainer",ref:Re,class:"monaco-editor-container"},null,512)],2)])):Z("",!0),M.value.success?(L(),z("div",ps,[h("div",{class:"output-header",onClick:Bt},[r[14]||(r[14]=h("div",{class:"output-title"},[h("span",null,"预期结果")],-1)),h("div",hs,[p(c,{class:"output-icon"},{default:_(()=>[(L(),Q(fe(re.value?S(ct):S(ut))))]),_:1})])]),h("div",{class:de(["output-content",{expanded:re.value}])},[h("div",{ref_key:"expectedResultEditorContainer",ref:Ae,class:"monaco-editor-container"},null,512)],2)])):Z("",!0)]),M.value.funcStepLogs&&M.value.funcStepLogs.length>0?(L(),z("div",{key:0,ref_key:"resultDetailsContainer",ref:Ee,class:"result-details"},[p(Gt,{modelValue:ue.value,"onUpdate:modelValue":r[9]||(r[9]=w=>ue.value=w),accordion:"",onChange:Vt},{default:_(()=>[(L(!0),z(Pe,null,He(M.value.funcStepLogs,(w,K)=>{var xe;return L(),Q(jt,{key:K,name:K,disabled:w.funcType==="logic"&&((xe=w.logicData)==null?void 0:xe.logicType)==="ifelse"},{title:_(()=>{var ee;return[h("div",gs,[h("div",ms,[p(ga,{type:w.funcType,"logic-type":(ee=w.logicData)==null?void 0:ee.logicType,size:24},null,8,["type","logic-type"])]),h("div",vs,[h("div",ys,[h("div",_s,[p(zt,{content:`${w.remark||w.title}`,placement:"top","show-after":500},{default:_(()=>[h("span",Ns,q(w.nodeId)+" | "+q(w.title),1)]),_:2},1032,["content"]),p(Ft,null,{default:_(()=>[h("span",bs,q(S(dt)(w.duration)),1),h("span",{class:de(["node-status",w.success?"success":"failure"])},[p(c,null,{default:_(()=>[(L(),Q(fe(w.success?S(it):S(ie))))]),_:2},1024)],2)]),_:2},1024)])])])])]}),default:_(()=>[h("div",$s,[h("div",ws,[r[15]||(r[15]=h("h4",null,"请求参数",-1)),h("div",Ts,[h("div",Ms,[p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Je(K.toString(),"input"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1},8,["onClick"]),p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Xe(K.toString(),"input"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1},8,["onClick"]),p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Ie(K.toString(),"input"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[(L(),Q(fe(C.value&&C.value.nodeId===K.toString()&&C.value.type==="input"?S(ie):S(De))))]),_:2},1024)]),_:2},1032,["onClick"])]),h("div",{ref_for:!0,ref:ee=>rt(ee,K.toString(),"input"),class:"monaco-editor-container"},null,512)])]),h("div",Es,[r[16]||(r[16]=h("h4",null,"响应结果",-1)),h("div",Is,[h("div",Ss,[p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Je(K.toString(),"output"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(ge))]),_:1})]),_:1},8,["onClick"]),p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Xe(K.toString(),"output"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[p(S(me))]),_:1})]),_:1},8,["onClick"]),p(f,{type:"primary",size:"small",circle:"",onClick:O(ee=>Ie(K.toString(),"output"),["stop"])},{default:_(()=>[p(c,null,{default:_(()=>[(L(),Q(fe(C.value&&C.value.nodeId===K.toString()&&C.value.type==="output"?S(ie):S(De))))]),_:2},1024)]),_:2},1032,["onClick"])]),h("div",{ref_for:!0,ref:ee=>rt(ee,K.toString(),"output"),class:"monaco-editor-container"},null,512)])])])]),_:2},1032,["name","disabled"])}),128))]),_:1},8,["modelValue"])],512)):Z("",!0)])):(L(),z("div",Cs,[p(y,{description:"暂无执行结果"})]))])]),_:1})]),_:1},8,["modelValue"])])],2)],64)}}});const As=ht(Ls,[["__scopeId","data-v-7d13c9d5"]]);export{ga as B,R as L,As as T,ia as a,Bs as b,Os as c,Rs as d,ca as g,Vs as i,ft as u};
